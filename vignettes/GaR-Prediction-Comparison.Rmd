
```{r load_prediction_libraries}

library(stargazer)

```


```{r set_forecast_parameters}

theme_set(theme_bw())

forecast_parameters = list(
  win_len = 40,
  win_type_expanding = TRUE,
  df = df %>% filter(Date < as.yearqtr("2020Q1"))
    )

forecast_comparisons = list()

forecast_data_list = list()

forecast_model_fit = list()

```


<!-- Forecasts: GaR, staff, Macro -->


```{r make_actual_gdp_df}

forecast_data_list$actual_gdp_df = forecast_parameters$df %>% 
  select(Date, GDP) %>% 
  filter(complete.cases(.)) %>% 
  rename(GDP_actual = GDP) %>% 
  mutate(Forecast_Period = paste(Date - 1, Date, sep = "-")) %>% 
  select(-Date) %>% 
  select(Forecast_Period, GDP_actual)

```


```{r GaR_Forecast}


models_list = list(GaR_Forecast = current_partition,
                   Intercept_Forecast = NULL,
                   Macro_Forecast = partitions_list$macro)


temp_forecasts = map(
  names(models_list),function(temp_name){
  
  temp_forecast = get.gar.forecast(
  partitions_list = models_list[[temp_name]],
  vars_df = forecast_parameters$df,
  target_var_name = "GDP",
  horizon_list = parameters_list$horizon_list,
  quantile_vec = parameters_list$quantile_vec,
  pca.align.list = list(
    Dom_FCI = list(
      var_name = "Spread_CPI_corp",
      positive_direction = FALSE),
    Dom_Macro = list(var_name = "GDP"),
    Global = list(var_name = "rate_euro"),
    FinCycle = list(var_name = "Credit")),
  win_len = forecast_parameters$win_len,
  win_type_expanding = forecast_parameters$win_type_expanding) %>% 
    filter(complete.cases(.)) %>% 
    mutate(Forecast_Period = paste(
    Date + as.numeric(Horizon) * 0.25 - 1,
    Date + as.numeric(Horizon) * 0.25,
    sep = "-")) %>% 
    mutate(Horizon = as_factor(Horizon)) %>% 
    rename(!!temp_name := GaR_forecast)

  
  
  
  
}
)

names(temp_forecasts) = names(models_list)

forecast_data_list = c(
  forecast_data_list,
  temp_forecasts
  )


rm(models_list,temp_forecasts)


```


```{r test_GaR_forecast, eval=FALSE}

gar_forecast_fixed = get.gar.forecast(
  partitions_list = current_partition,
  vars_df = forecast_parameters$df,
  target_var_name = "GDP",
  horizon_list = parameters_list$horizon_list,
  quantile_vec = parameters_list$quantile_vec,
  pca.align.list = list(
    Dom_FCI = list(
      var_name = "Spread_CPI_corp",
      positive_direction = FALSE),
    Dom_Macro = list(var_name = "GDP"),
    Global = list(var_name = "rate_euro"),
    FinCycle = list(var_name = "Credit")),
  win_len = forecast_parameters$win_len,
  win_type_expanding = FALSE) %>% 
    filter(complete.cases(.)) %>% 
    mutate(Forecast_Period = paste(
    Date + as.numeric(Horizon) * 0.25 - 1,
    Date + as.numeric(Horizon) * 0.25,
    sep = "-")) %>% 
    mutate(Horizon = as_factor(Horizon))


```


```{r, make_staff_forecast}

staff_forecast_conversion_table = read_csv(
  paste0(file.path(Sys.getenv("USERPROFILE"), fsep = "\\"),
         "\\OneDrive - Bank Of Israel\\Data\\BoI\\GaR_Data\\",
         "Staff_forecast_conversion_table.csv"))

staff_forecast_conversion_table = staff_forecast_conversion_table %>% 
  filter(Type == "YoY") %>% 
  select(-Type) %>% 
  mutate(Horizon = as_factor(Horizon,)) %>% 
  pivot_longer(cols = c(-Horizon),
               names_to = "Quantile",
               values_to = "Conversion_Coeff") %>% 
  mutate(Conversion_Coeff = Conversion_Coeff * 0.01)

staff_forecast_conversion_table = full_join(
  staff_forecast_conversion_table,
  select(raw_df, Date), by = character())
  

staff_forecast_df_h1 = raw_df %>% 
  select(Date, staff_1Q) %>% 
  rename_all(.funs = list(~str_remove(.,"staff_"))) %>% 
  gather(key = Quarter,value = Forecast, - Date) %>% 
  filter(complete.cases(.)) %>% 
  left_join(.,raw_df %>% 
              select(Date, GDP) %>% 
              mutate(GDP = GDP / lag(GDP,3) - 1)) %>% 
  mutate(Staff_Forecast = Forecast * 0.25 * 0.01 + GDP) %>% 
  select(Date,Staff_Forecast) %>% 
  mutate(Forecast_Period = paste(Date - 0.75,Date + 0.25,
                                 sep = "-")) %>% 
  mutate(Horizon = "1")


staff_forecast_df_h4 = raw_df %>%
  select(Date, staff_1Q, staff_2Q, staff_3Q, staff_4Q) %>%
  rename_all(.funs = list(~str_remove(.,"staff_"))) %>%
  gather(key = Quarter,value = Forecast, - Date) %>%
  group_by(Date) %>%
  summarise(Staff_Forecast = mean(Forecast) * 0.01) %>%
  ungroup() %>%
  filter(complete.cases(.)) %>%
  mutate(Forecast_Period = paste(Date,(Date + 1),
                                 sep = "-")) %>%
  mutate(Horizon = "4")



staff_forecast_df_h8 = raw_df %>% 
  select(Date, staff_5Q, staff_6Q, staff_7Q, staff_8Q) %>% 
  rename_all(.funs = list(~str_remove(.,"staff_"))) %>% 
  gather(key = Quarter,value = Forecast, - Date) %>% 
  group_by(Date) %>% 
  summarise(Staff_Forecast = mean(Forecast) * 0.01) %>% 
  ungroup() %>% 
  filter(complete.cases(.)) %>% 
  mutate(Forecast_Period = paste((Date + 1),(Date + 2),
                                 sep = "-")) %>% 
  mutate(Horizon = "8")

forecast_data_list$staff_forecast = list(
  staff_forecast_df_h1,
  staff_forecast_df_h4,
  staff_forecast_df_h8) %>% 
  bind_rows() %>% 
  mutate(Date = as.yearqtr(Date)) %>% 
  inner_join(., staff_forecast_conversion_table,
             by = c("Date","Horizon")) %>% 
  mutate(Staff_Forecast = Staff_Forecast + Conversion_Coeff) %>% 
  mutate(Quantile = str_replace_all(Quantile,"0.5","0.50")) %>% 
  select(-Conversion_Coeff) %>% 
  select(Date, Horizon, Quantile, Forecast_Period, Staff_Forecast)

rm(staff_forecast_df_h8, staff_forecast_df_h1,
   staff_forecast_conversion_table)



```



The first stage is to obtain out of sample forecast which is calculated in the following manner : first a model is fitted on a subset of the data (the window) and then the outcome is predicted based on new data that is determined by the out of sample step.


<!-- Model fit evaluation -->


The model fit evaluation which is performed according to quantile $R^{2}$.


```{r gar_macro_r_squared}

gar_macro_r2_df = forecast_data_list[c("GaR_Forecast",
                                       "Intercept_Forecast",
                                       "Macro_Forecast")] %>% 
  reduce(inner_join,
         by = c("Date","Forecast_Period", "Horizon",
                "Quantile")) %>% 
  inner_join(forecast_data_list$actual_gdp_df,
             by = "Forecast_Period") %>% 
  select(-Forecast_Period)

forecast_model_fit$gar_macro_r2 = gar_macro_r2_df %>% 
  group_by(Horizon, Quantile) %>% 
  summarise(
    gar_r2_score = quantile.r2.score(
    realized_estimates = GDP_actual,
    forecast_values = GaR_Forecast,
    quantile = as.numeric(Quantile[1]),
    benchmark_values = Intercept_Forecast),
    macro_r2_score = quantile.r2.score(
    realized_estimates = GDP_actual,
    forecast_values = Macro_Forecast,
    quantile = as.numeric(Quantile[1]),
    benchmark_values = Intercept_Forecast))

rm(gar_macro_r2_df)

```


```{r gar_staff_r_squared}

gar_staff_r2_df = forecast_data_list[c("GaR_Forecast",
                                       "Intercept_Forecast")] %>% 
  reduce(inner_join,
         by = c("Forecast_Period", "Horizon",
                "Quantile","Date")) %>% 
  inner_join(forecast_data_list$staff_forecast,
             by = c("Forecast_Period", "Horizon",
                "Quantile")) %>% 
  inner_join(forecast_data_list$actual_gdp_df,
             by = "Forecast_Period")

forecast_model_fit$gar_staff_r2 = gar_staff_r2_df %>% 
  group_by(Horizon, Quantile) %>% 
  summarise(
    gar_r2_score = quantile.r2.score(
    realized_estimates = GDP_actual,
    forecast_values = GaR_Forecast,
    quantile = as.numeric(Quantile[1]),
    benchmark_values = Intercept_Forecast),
    staff_r2_score = quantile.r2.score(
    realized_estimates = GDP_actual,
    forecast_values = Staff_Forecast,
    quantile = as.numeric(Quantile[1]),
    benchmark_values = Intercept_Forecast))

rm(gar_staff_r2_df)

```


```{r plot_goodness_of_fit}

forecast_model_fit[c("gar_macro_r2",
                            "gar_staff_r2")] %>% 
  reduce(
    full_join,
    by = c("Horizon","Quantile"),
    suffix = c("_macro","_staff")
    ) %>% 
  rename_all(~str_remove_all(.,"_r2_score")) %>% 
  pivot_longer(cols = c(-Horizon, -Quantile),
               names_to = "model",
               values_to = "score") %>% 
  # filter(model != "gar_staff") %>% 
  ggplot(aes(x = Quantile, y = score, fill = model)) + 
  geom_col(position = "dodge") + 
  facet_wrap(~Horizon) + 
  scale_fill_viridis_d() + 
  theme_bw() + 
  theme(legend.position = "bottom", legend.title = element_blank())
  

```


<!-- Comparisons: gar vs actual, gar vs macro (rmse and quantile fit), gar vs staff -->


```{r gar_actual_comparison, eval=FALSE}

forecast_comparisons$gar_actual = forecast_data_list$GaR_Forecast %>% 
  filter(Quantile == "0.50") %>% 
  select(-Quantile) %>% 
  inner_join(.,forecast_data_list$actual_gdp_df,
             by = "Forecast_Period") %>% 
  mutate(Error = GDP_actual - GaR_Forecast)



```


```{r gar_staff_comparison, eval=FALSE}

forecast_comparisons$gar_staff = forecast_data_list[
  c("GaR_Forecast","staff_forecast")] %>% 
  reduce(inner_join,
         by = c("Date","Forecast_Period", "Horizon", "Quantile")) %>% 
  inner_join(forecast_data_list$actual_gdp_df,
             by = "Forecast_Period") %>% 
  mutate(across(.cols = c(GaR_Forecast, Staff_Forecast),
                .fns = ~ GDP_actual - .,
                .names = "{col}_error"))

```


```{r gar_macro_comparison, eval=FALSE}

forecast_comparisons$gar_macro = forecast_data_list[
  c("GaR_Forecast","Macro_Forecast")] %>% 
  reduce(inner_join,
         by = c("Date","Forecast_Period", "Horizon",
                "Quantile")) %>% 
  inner_join(forecast_data_list$actual_gdp_df,
             by = "Forecast_Period") %>% 
  mutate(across(.cols = c(GaR_Forecast, Macro_Forecast),
                .fns = ~ GDP_actual - .,
                .names = "{col}_error"))

```


In the next stage we compare the forecasts of the different models by matching them on Horizon, Forecast Period, Forecast Status and Win Type (where appropriate). The actual GDP growth is matched on Forecast Period only, staff forecast is matched on Forecast Period and Horizon.


\subsection{Comparison to actual GDP}

We take actual GDP YoY growth rates and compare them with the predicted median YoY GDP growth rates. The matching between the actual and forecasted values is based on
forecasted period

```{r plot_gar_actual_rmse, eval=FALSE}

ggplot(forecast_model_fit$gar_actual_rmse,
       aes(x = reorder(Horizon, as.numeric(Horizon)), y = RMSE, fill = Horizon)) + 
  facet_grid(rows = vars(Forecast_Status), cols = vars(Win_Type), scales = "free_y") + 
  geom_col(width = 0.5) + 
  labs(x = "", y = "", title = "Forecast fit - RMSE") + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.1)) + 
  theme_bw() + 
  theme(legend.position = "bottom")

```


```{r plot_actual_quantile_fit_score, eval=FALSE}


ggplot(forecast_model_fit$gar_actual_fit_score %>% 
  group_by(Horizon,Win_Type,Forecast_Status) %>% 
  summarise(SD = mean(Score, na.rm = TRUE), .groups = "drop"),
  aes(x = Horizon, y = SD, fill = Horizon)) + 
  facet_grid(rows = vars(Forecast_Status), cols = vars(Win_Type), scales = "free_y") + 
  geom_col(width = 0.5) + 
  labs(x = "", y = "",
       title = "Forecast fit - average quantile fit score") + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.1)) + 
  theme_bw() + 
  theme(legend.position = "bottom")


```



\section{Residuals analysis}

```{r plot_gar_forecast}

forecast_data_list$GaR_Forecast %>% 
  ggplot(aes(x = Date, y = GaR_Forecast)) + 
  geom_line() + 
  geom_hline(yintercept = 0, color = "blue", linetype = "dashed") + 
  xlab(NULL) + 
  ylab(NULL) + 
  labs(title = "GaR Predictions (out of sample)") + 
  scale_y_continuous(labels = scales::percent_format()) + 
  facet_grid(rows = vars(Horizon), cols = vars(Quantile), scales = "free")
```


```{r plot_staff_forecast}

forecast_data_list$staff_forecast %>% 
  ggplot(aes(x = Date, y =Staff_Forecast)) + 
  geom_line() + 
  geom_hline(yintercept = 0, color = "blue", linetype = "dashed") + 
  xlab(NULL) + 
  ylab(NULL) + 
  labs(title = "Staff Predictions") + 
  scale_y_continuous(labels = scales::percent_format()) + 
  facet_grid(rows = vars(Horizon), cols = vars(Quantile), scales = "free")
```


```{r plot_intercept_forecast}

forecast_data_list$Intercept_Forecast %>% 
  ggplot(aes(x = Date, y = Intercept_Forecast)) + 
  geom_line() + 
  geom_hline(yintercept = 0, color = "blue", linetype = "dashed") + 
  xlab(NULL) + 
  ylab(NULL) + 
  labs(title = "Intercept GaR Predictions (out of sample)") + 
  scale_y_continuous(labels = scales::percent_format()) + 
  facet_grid(rows = vars(Horizon), cols = vars(Quantile), scales = "free")
```




```{r plot_gar_vs_staff}

forecast_data_list[c("GaR_Forecast","staff_forecast")] %>% 
  reduce(inner_join, by = c("Date",
                            "Horizon",
                            "Quantile",
                            "Forecast_Period")) %>% 
  select(-Forecast_Period) %>% 
  pivot_longer(cols = ends_with("Forecast")) %>% 
  mutate(name = str_remove_all(name,"_Forecast")) %>% 
  ggplot(aes(x = Date, y = value, color = name)) + 
  geom_line() + 
  facet_grid(rows = vars(Horizon),cols = vars(Quantile)) + 
  labs(x = "", y = "") + 
  theme_bw() + 
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5))

```

