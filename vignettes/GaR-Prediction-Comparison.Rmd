
```{r load_prediction_libraries}

library(stargazer)

```


```{r set_forecast_parameters}

forecast_parametrs = list(win_len = 30, out_of_sample_step = 1,
                          fan_chart_date = results$reg_df$Date[nrow(results$reg_df)])

```


```{r run_robustness_analysis}

basic_fincycle = run.GaR.analysis(partitions_list = partitions_list$basic_fincycle,
                                  vars_df = df %>% 
                                    mutate(Spread_CPI_corp = -1 * Spread_CPI_corp),
                                  horizon_list = parameters_list$horizon_list,
                                  quantile_vec = parameters_list$quantile_vec)

robustness_results = list(OZMG = results,
                          basic_fincycle = basic_fincycle)

rm(basic_fincycle)

```


```{r GaR_forecast}

gar_forecast = lapply(names(robustness_results), function(temp_name){
  
  gar_forecast_df = get.gar.forecast(gar_obj = robustness_results[[temp_name]],
                        win_len = forecast_parametrs$win_len,
                        quantile_vec = parameters_list$quantile_vec,
                        out_of_sample_step = forecast_parametrs$out_of_sample_step)
  
  gar_forecast_df = gar_forecast_df %>% 
    filter(complete.cases(.)) %>% 
    mutate(Partition = temp_name)
  
  return(gar_forecast_df)
  
}) %>% 
  bind_rows()
  

```


```{r compare_partitions_forecast}

forecast_accuracy_table = gar_forecast %>% 
  group_by(Partition, Forecast_Status,Horizon, Quantile) %>% 
  summarise(MAD = round(mean(abs(Error)),4),
            RMSE = round(sqrt(mean(Error ^ 2)),4))


```


```{r output_accuracy_table, results='asis'}

stargazer(forecast_accuracy_table %>% 
            ungroup() %>% 
            mutate(Horizon = as.character(Horizon)),
          summary = FALSE, header = FALSE,
          label = "forecast_accuracy",
          title = "Forecast accuracy")

```

\subsection{Fan charts}

```{r}


fan_chart_df = lapply(names(results$quantile_reg), function(temp_name){
  
  temp_df = predict.rq(results$quantile_reg[[temp_name]],
                       newdata = results$reg_df[
                         results$reg_df$Date == forecast_parametrs$fan_chart_date,]) %>% 
    as.data.frame() %>%
    setNames("Prediction") %>% 
    mutate(Quantile = str_remove(rownames(.),"tau= ")) %>% 
    mutate(Date = forecast_parametrs$fan_chart_date + 0.25 * as.numeric(temp_name))
  
  
}) %>% 
  bind_rows() %>% 
  spread(key = Quantile,value = Prediction) %>% 
  rename_at(.vars = vars(-Date),.funs = list(~paste0("Q_",.)))


fan_chart_df[,-1] = t(apply(as.matrix(fan_chart_df[,-1]),1,
        function(temp_row){return(sort(as.numeric(temp_row)))}))

fan_chart_df = bind_rows(fan_chart_df,data.frame(Date = forecast_parametrs$fan_chart_date,
                       matrix(ncol = ncol(fan_chart_df) - 1,
                              df$GDP[df$Date == forecast_parametrs$fan_chart_date])) %>% 
                         setNames(names(fan_chart_df))) %>% 
  mutate(Date = as.yearqtr(Date))
  


ggplot() + 
  geom_line(data = df %>% 
              select(Date, GDP) %>% 
              filter(complete.cases(.)) %>% 
              filter(Date <= forecast_parametrs$fan_chart_date),
            aes(x = Date, y = GDP)) + 
  geom_ribbon(data = fan_chart_df, aes(x = Date, ymin = Q_0.05, ymax = Q_0.95),
              fill = "lightblue",
              alpha = 0.6) +
   geom_ribbon(data = fan_chart_df, aes(x = Date, ymin = Q_0.25, ymax = Q_0.75),
              fill = "lightblue",
              alpha = 0.5) +
  geom_line(data = fan_chart_df, aes(x = Date, y = Q_0.50), color = "white") + 
  labs(x = "", y = "",title = "Fan chart for GDP YoY growth rate") + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.5)) + 
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5))
    


```




\subsection{Forecast accuracy}

We take the predicted YoY GDP growth rates and compare them with actual GDP YoY growth rates.  The accuracy measures for different time horizons are summarized in table \ref{forecast_accuracy}. We use in sample and out of sample comparison in order to test the robustness of partition specification. The out of sample forecast is constracted by estimation of a rolling window of length
`r forecast_parametrs$win_len` and forecasting `r forecast_parametrs$out_of_sample_step` step ahead.

```{r plot_accuracy_table}

ggplot(forecast_accuracy_table, aes(x = Horizon, y = MAD,
                                    fill = Partition)) + 
  facet_wrap(~Forecast_Status) + 
  geom_bar(stat = "identity",position = "dodge", width = 0.5) + 
  # scale_fill_manual(values = c("red","blue","black","gray")) + 
  theme_bw() + 
  theme(legend.position = "bottom")

```

