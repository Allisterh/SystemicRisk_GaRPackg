
```{r load_prediction_libraries}

library(stargazer)

```


```{r set_forecast_parameters}

theme_set(theme_bw())

forecast_parameters = list(
  win_len = 40,
  win_type_expanding = TRUE,
  df = df %>% filter(Date < as.yearqtr("2020Q1"))
    )

forecast_comparisons = list()

forecast_data_list = list()

forecast_model_fit = list()

```


<!-- Forecasts: GaR, staff, Macro -->


```{r make_df}

realized_df = forecast_parameters$df %>% 
  select(Date, GDP) %>% 
  filter(complete.cases(.)) %>% 
  rename(realized = GDP) %>% 
  mutate(Forecast_Period = paste(Date - 1, Date, sep = "-")) %>% 
  select(-Date) %>% 
  select(Forecast_Period, realized) %>% 
  as_tibble()

benchmark_df = get.gar.forecast(
  partitions_list = NULL,
  vars_df = forecast_parameters$df,
  target_var_name = "GDP",
  horizon_list = parameters_list$horizon_list,
  quantile_vec = parameters_list$quantile_vec,
  win_len = forecast_parameters$win_len,
  win_type_expanding = forecast_parameters$win_type_expanding) %>%          mutate(Forecast_Period = paste(
    Date + as.numeric(Horizon) * 0.25 - 1,
    Date + as.numeric(Horizon) * 0.25,
    sep = "-"
    )) %>%
  mutate(Horizon = as_factor(Horizon)) %>% 
  rename(benchmark = GaR_forecast)

staff_forecast_df = import.staff.forecast(raw_df = raw_df) %>% 
  as_tibble() %>% 
  rename(prediction = Staff_Forecast)

staff_forecast_df = list(
  name = "Staff",
  partition = list(staff = NA),
  pred_df = staff_forecast_df) %>% 
  enframe() %>% 
  pivot_wider()

```



```{r GaR_Forecast}

models_df = list(GaR_Forecast = partitions_list$basic,
                 Macro_Forecast = partitions_list$macro) %>% 
  enframe(value = "partition")

models_df = models_df %>%
  mutate(pred_df = map(partition,function(temp_part){

      temp_forecast = get.gar.forecast(
        partitions_list = temp_part,
        vars_df = forecast_parameters$df,
        target_var_name = "GDP",
        horizon_list = parameters_list$horizon_list,
        quantile_vec = parameters_list$quantile_vec,
        pca.align.list = list(
          Dom_FCI = list(var_name = "Spread_CPI_corp",
                         positive_direction = FALSE),
          Dom_Macro = list(var_name = "GDP"),
          Global = list(var_name = "gdp_us"),
          FinCycle = list(var_name = "Credit")
        ),
        win_len = forecast_parameters$win_len,
        win_type_expanding = forecast_parameters$win_type_expanding)
      
      temp_forecast = temp_forecast %>% 
        filter(complete.cases(.)) %>%
        mutate(Forecast_Period = paste(
          Date + as.numeric(Horizon) * 0.25 - 1,
          Date + as.numeric(Horizon) * 0.25,
          sep = "-"
        )) %>%
        mutate(Horizon = as_factor(Horizon)) %>% 
        rename(prediction = GaR_forecast)
        
        
      return(temp_forecast)
      
      }))

models_df = models_df %>% 
  rbind(staff_forecast_df)

models_df = models_df %>% 
  mutate(realized = map(1:nrow(.),~realized_df)) %>% 
  mutate(benchmark = map(1:nrow(.),~benchmark_df))


```


```{r calculate_r_2}

models_df = models_df %>% 
  mutate(r2_score = pmap(.l = list(pred_df,realized, benchmark),
                     .f = function(pred_df,realized, benchmark){

                       temp_score = collect_quantile_r2_score(
                         pred_df = pred_df,
                         realized_df = realized,
                         benchmark_df = benchmark)
                       return(temp_score)
                     }))

```



The first stage is to obtain out of sample forecast which is calculated in the following manner : first a model is fitted on a subset of the data (the window) and then the outcome is predicted based on new data that is determined by the out of sample step.


<!-- Model fit evaluation -->


The model fit evaluation which is performed according to quantile $R^{2}$.


```{r plot_goodness_of_fit}


models_df %>% 
  select(name, r2_score) %>% 
  unnest(r2_score) %>% 
  mutate(name = map_chr(name,~.)) %>% 
  ggplot(aes(x = Quantile, y = score, fill = name)) + 
  geom_col(position = "dodge") + 
  scale_fill_viridis_d(option = "plasma") + 
  facet_wrap(~Horizon) + 
  theme(legend.position = "bottom")

```


<!-- Comparisons: gar vs actual, gar vs macro (rmse and quantile fit), gar vs staff -->


```{r gar_actual_comparison, eval=FALSE}

forecast_comparisons$gar_actual = forecast_data_list$GaR_Forecast %>% 
  filter(Quantile == "0.50") %>% 
  select(-Quantile) %>% 
  inner_join(.,forecast_data_list$actual_gdp_df,
             by = "Forecast_Period") %>% 
  mutate(Error = GDP_actual - GaR_Forecast)



```


```{r gar_staff_comparison, eval=FALSE}

forecast_comparisons$gar_staff = forecast_data_list[
  c("GaR_Forecast","staff_forecast")] %>% 
  reduce(inner_join,
         by = c("Date","Forecast_Period", "Horizon", "Quantile")) %>% 
  inner_join(forecast_data_list$actual_gdp_df,
             by = "Forecast_Period") %>% 
  mutate(across(.cols = c(GaR_Forecast, Staff_Forecast),
                .fns = ~ GDP_actual - .,
                .names = "{col}_error"))

```


```{r gar_macro_comparison, eval=FALSE}

forecast_comparisons$gar_macro = forecast_data_list[
  c("GaR_Forecast","Macro_Forecast")] %>% 
  reduce(inner_join,
         by = c("Date","Forecast_Period", "Horizon",
                "Quantile")) %>% 
  inner_join(forecast_data_list$actual_gdp_df,
             by = "Forecast_Period") %>% 
  mutate(across(.cols = c(GaR_Forecast, Macro_Forecast),
                .fns = ~ GDP_actual - .,
                .names = "{col}_error"))

```


In the next stage we compare the forecasts of the different models by matching them on Horizon, Forecast Period, Forecast Status and Win Type (where appropriate). The actual GDP growth is matched on Forecast Period only, staff forecast is matched on Forecast Period and Horizon.


\subsection{Comparison to actual GDP}

We take actual GDP YoY growth rates and compare them with the predicted median YoY GDP growth rates. The matching between the actual and forecasted values is based on
forecasted period

```{r plot_gar_actual_rmse, eval=FALSE}

ggplot(forecast_model_fit$gar_actual_rmse,
       aes(x = reorder(Horizon, as.numeric(Horizon)), y = RMSE, fill = Horizon)) + 
  facet_grid(rows = vars(Forecast_Status), cols = vars(Win_Type), scales = "free_y") + 
  geom_col(width = 0.5) + 
  labs(x = "", y = "", title = "Forecast fit - RMSE") + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.1)) + 
  theme_bw() + 
  theme(legend.position = "bottom")

```


```{r plot_actual_quantile_fit_score, eval=FALSE}


ggplot(forecast_model_fit$gar_actual_fit_score %>% 
  group_by(Horizon,Win_Type,Forecast_Status) %>% 
  summarise(SD = mean(Score, na.rm = TRUE), .groups = "drop"),
  aes(x = Horizon, y = SD, fill = Horizon)) + 
  facet_grid(rows = vars(Forecast_Status), cols = vars(Win_Type), scales = "free_y") + 
  geom_col(width = 0.5) + 
  labs(x = "", y = "",
       title = "Forecast fit - average quantile fit score") + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.1)) + 
  theme_bw() + 
  theme(legend.position = "bottom")


```



\section{Residuals analysis}

```{r plot_gar_forecast, eval=FALSE}

forecast_data_list$GaR_Forecast %>% 
  ggplot(aes(x = Date, y = GaR_Forecast)) + 
  geom_line() + 
  geom_hline(yintercept = 0, color = "blue", linetype = "dashed") + 
  xlab(NULL) + 
  ylab(NULL) + 
  labs(title = "GaR Predictions (out of sample)") + 
  scale_y_continuous(labels = scales::percent_format()) + 
  facet_grid(rows = vars(Horizon), cols = vars(Quantile), scales = "free")


forecast_data_list$GaR_Forecast %>% 
  ggplot(aes(x = Date, y = GaR_Forecast, color = Quantile)) + 
  geom_line() + 
  geom_hline(yintercept = 0, color = "blue", linetype = "dashed") + 
  xlab(NULL) + 
  ylab(NULL) + 
  labs(title = "GaR Predictions (out of sample)") + 
  scale_y_continuous(labels = scales::percent_format()) + 
  facet_wrap(~Horizon, scales = "free")
```


```{r plot_staff_forecast, eval=FALSE}

forecast_data_list$staff_forecast %>% 
  ggplot(aes(x = Date, y =Staff_Forecast)) + 
  geom_line() + 
  geom_hline(yintercept = 0, color = "blue", linetype = "dashed") + 
  xlab(NULL) + 
  ylab(NULL) + 
  labs(title = "Staff Predictions") + 
  scale_y_continuous(labels = scales::percent_format()) + 
  facet_grid(rows = vars(Horizon), cols = vars(Quantile), scales = "free")
```


```{r plot_intercept_forecast, eval=FALSE}

forecast_data_list$Intercept_Forecast %>% 
  ggplot(aes(x = Date, y = Intercept_Forecast)) + 
  geom_line() + 
  geom_hline(yintercept = 0, color = "blue", linetype = "dashed") + 
  xlab(NULL) + 
  ylab(NULL) + 
  labs(title = "Intercept GaR Predictions (out of sample)") + 
  scale_y_continuous(labels = scales::percent_format()) + 
  facet_grid(rows = vars(Horizon), cols = vars(Quantile), scales = "free")
```


```{r plot_gar_vs_staff, eval=FALSE}

forecast_data_list[c("GaR_Forecast","staff_forecast")] %>% 
  reduce(inner_join, by = c("Date",
                            "Horizon",
                            "Quantile",
                            "Forecast_Period")) %>% 
  select(-Forecast_Period) %>% 
  pivot_longer(cols = ends_with("Forecast")) %>% 
  mutate(name = str_remove_all(name,"_Forecast")) %>% 
  ggplot(aes(x = Date, y = value, color = name)) + 
  geom_line() + 
  facet_grid(rows = vars(Horizon),cols = vars(Quantile)) + 
  labs(x = "", y = "") + 
  theme_bw() + 
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5))

```

