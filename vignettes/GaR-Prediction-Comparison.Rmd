
```{r load_prediction_libraries}

library(stargazer)

```


```{r set_forecast_parameters}

forecast_parameters = list(win_len = 30, out_of_sample_step = 0)

forecast_comparisons = list()

forecast_data_list = list()

forecast_model_fit = list()

```


<!-- Forecasts: GaR, staff, Macro -->


```{r make_actual_gdp_df}

forecast_data_list$actual_gdp_df = df %>% 
  select(Date, GDP) %>% 
  filter(complete.cases(.)) %>% 
  rename(GDP_actual = GDP) %>% 
  mutate(Forecast_Period = paste(Date - 1, Date, sep = "-")) %>% 
  select(-Date) %>% 
  select(Forecast_Period, GDP_actual)

```


```{r GaR_forecast}

forecast_data_list$gar_forecast = get.gar.forecast(
    gar_obj = results,
    win_len = forecast_parameters$win_len,
    quantile_vec = parameters_list$quantile_vec,
    out_of_sample_step = forecast_parameters$out_of_sample_step,
    win_type = "fixed") %>% 
    filter(complete.cases(.)) %>% 
  bind_rows() %>% 
  mutate(Date = as.yearqtr(Date)) %>% 
  mutate(Forecast_Period = paste(
    Date + as.numeric(Horizon) * 0.25 - 1,
    Date + as.numeric(Horizon) * 0.25,
    sep = "-")) %>% 
  mutate(Horizon = as_factor(Horizon)) %>% 
  select(Date, Horizon, Quantile,Forecast_Status,
         Forecast_Period,GaR_forecast)



```


```{r Intercept_forecast}

intercept_model = run.GaR.analysis(partitions_list = NULL,
                   vars_df = df,
                   horizon_list = parameters_list$horizon_list,
                   quantile_vec = parameters_list$quantile_vec,
                   pca.align.list = list(Dom_FCI = list(
                     var_name = "Spread_CPI_corp",
                     positive_direction = FALSE)))


forecast_data_list$intercept_forecast = get.gar.forecast(
    gar_obj = intercept_model,
    win_len = forecast_parameters$win_len,
    quantile_vec = parameters_list$quantile_vec,
    out_of_sample_step = forecast_parameters$out_of_sample_step,
    win_type = "fixed") %>% 
    filter(complete.cases(.)) %>% 
  bind_rows() %>% 
  mutate(Date = as.yearqtr(Date)) %>% 
  mutate(Forecast_Period = paste(
    Date + as.numeric(Horizon) * 0.25 - 1,
    Date + as.numeric(Horizon) * 0.25,
    sep = "-")) %>% 
  mutate(Horizon = as_factor(Horizon)) %>% 
  rename(Intercept_Forecast = GaR_forecast) %>% 
  select(Date, Horizon, Quantile,Forecast_Status,
         Forecast_Period, Intercept_Forecast)

rm(intercept_model)

```


```{r, make_staff_forecast}

staff_forecast_conversion_table = read_csv(
  paste0(file.path(Sys.getenv("USERPROFILE"), fsep = "\\"),
         "\\OneDrive - Bank Of Israel\\Data\\BoI\\GaR_Data\\",
         "Staff_forecast_conversion_table.csv"))

staff_forecast_conversion_table = staff_forecast_conversion_table %>% 
  mutate(Horizon = as_factor(Horizon,)) %>% 
  pivot_longer(cols = c(-Horizon),
               names_to = "Quantile",
               values_to = "Conversion_Coeff") %>% 
  mutate(Conversion_Coeff = Conversion_Coeff * 0.01)

staff_forecast_conversion_table = full_join(
  staff_forecast_conversion_table,
  select(raw_df, Date), by = character())
  

staff_forecast_df_h1 = raw_df %>% 
  select(Date, staff_1Q) %>% 
  rename_all(.funs = list(~str_remove(.,"staff_"))) %>% 
  gather(key = Quarter,value = Forecast, - Date) %>% 
  filter(complete.cases(.)) %>% 
  left_join(.,raw_df %>% 
              select(Date, GDP) %>% 
              mutate(GDP = GDP / lag(GDP,3) - 1)) %>% 
  mutate(Staff_Forecast = Forecast * 0.25 * 0.01 + GDP) %>% 
  select(Date,Staff_Forecast) %>% 
  mutate(Forecast_Period = paste(Date - 0.75,Date + 0.25,
                                 sep = "-")) %>% 
  mutate(Horizon = "1")

staff_forecast_df_h8 = raw_df %>% 
  select(Date, staff_5Q, staff_6Q, staff_7Q, staff_8Q) %>% 
  rename_all(.funs = list(~str_remove(.,"staff_"))) %>% 
  gather(key = Quarter,value = Forecast, - Date) %>% 
  group_by(Date) %>% 
  summarise(Staff_Forecast = mean(Forecast) * 0.01) %>% 
  ungroup() %>% 
  filter(complete.cases(.)) %>% 
  mutate(Forecast_Period = paste((Date + 1),(Date + 2),
                                 sep = "-")) %>% 
  mutate(Horizon = "8")

forecast_data_list$staff_forecast = bind_rows(staff_forecast_df_h1,
                           staff_forecast_df_h8) %>% 
  mutate(Date = as.yearqtr(Date)) %>% 
  inner_join(., staff_forecast_conversion_table,
             by = c("Date","Horizon")) %>% 
  mutate(Staff_Forecast = Staff_Forecast + Conversion_Coeff) %>% 
  select(-Conversion_Coeff) %>% 
  select(Date, Horizon, Quantile, Forecast_Period, Staff_Forecast)

rm(staff_forecast_df_h8, staff_forecast_df_h1,
   staff_forecast_conversion_table)



```


```{r, macro_forecast}

macro_gar_model = run.GaR.analysis(
  partitions_list = partitions_list$macro,
  vars_df = df,
  horizon_list = parameters_list$horizon_list,
  quantile_vec = parameters_list$quantile_vec,
  run_ols_reg = FALSE)

forecast_data_list$macro_gar_forecast = get.gar.forecast(
    gar_obj = macro_gar_model,
    win_len = forecast_parameters$win_len,
    quantile_vec = parameters_list$quantile_vec,
    out_of_sample_step = forecast_parameters$out_of_sample_step,
    win_type = "fixed") %>% 
    filter(complete.cases(.)) %>% 
  bind_rows() %>% 
  mutate(Date = as.yearqtr(Date)) %>% 
  mutate(Forecast_Period = paste(
    Date + as.numeric(Horizon) * 0.25 - 1,
    Date + as.numeric(Horizon) * 0.25,
    sep = "-")) %>% 
  mutate(Horizon = as_factor(Horizon))  %>% 
  rename(Macro_Forecast = GaR_forecast) %>% 
  select(Date, Horizon, Quantile,Forecast_Status,
         Forecast_Period, Macro_Forecast)
  


rm(macro_gar_model)

```


The first stage is to obtain out of sample forecast which is calculated in the following manner : first a model is fitted on a subset of the data (the window) and then the outcome is predicted based on new data that is determined by the out of sample step (currently next period)

<!-- Comparisons: gar vs actual, gar vs macro (rmse and quantile fit), gar vs staff -->


```{r gar_actual_comparison, eval=FALSE}

forecast_comparisons$gar_actual = forecast_data_list$gar_forecast %>% 
  filter(Quantile == "0.50") %>% 
  select(-Quantile) %>% 
  inner_join(.,forecast_data_list$actual_gdp_df,
             by = "Forecast_Period") %>% 
  mutate(Error = GDP_actual - GaR_forecast)



```


```{r gar_staff_comparison, eval=FALSE}

forecast_comparisons$gar_staff = forecast_data_list[
  c("gar_forecast","staff_forecast")] %>% 
  reduce(inner_join,
         by = c("Date","Forecast_Period", "Horizon", "Quantile")) %>% 
  inner_join(forecast_data_list$actual_gdp_df,
             by = "Forecast_Period") %>% 
  mutate(across(.cols = c(GaR_forecast, Staff_Forecast),
                .fns = ~ GDP_actual - .,
                .names = "{col}_error"))

```


```{r gar_macro_comparison, eval=FALSE}

forecast_comparisons$gar_macro = forecast_data_list[
  c("gar_forecast","macro_gar_forecast")] %>% 
  reduce(inner_join,
         by = c("Date","Forecast_Period", "Horizon",
                "Quantile","Forecast_Status")) %>% 
  inner_join(forecast_data_list$actual_gdp_df,
             by = "Forecast_Period") %>% 
  mutate(across(.cols = c(GaR_forecast, Macro_Forecast),
                .fns = ~ GDP_actual - .,
                .names = "{col}_error"))

```


In the next stage we compare the forecasts of the different models by matching them on Horizon, Forecast Period, Forecast Status and Win Type (where appropriate). The actual GDP growth is matched on Forecast Period only, staff forecast is matched on Forecast Period and Horizon.


<!-- Model fit evaluation -->


The third stage is model fit evaluation which is performed according to quantile $R^{2}$.


```{r gar_macro_r_squared}

gar_macro_r2_df = forecast_data_list[c("gar_forecast",
                                       "intercept_forecast",
                                       "macro_gar_forecast")] %>% 
  map(~ filter(.,Forecast_Status == "Out of Sample") %>% 
        select(-Forecast_Status)) %>% 
  reduce(inner_join,
         by = c("Date","Forecast_Period", "Horizon",
                "Quantile")) %>% 
  inner_join(forecast_data_list$actual_gdp_df,
             by = "Forecast_Period") %>% 
  select(-Forecast_Period)

forecast_model_fit$gar_macro_r2 = gar_macro_r2_df %>% 
  group_by(Horizon, Quantile) %>% 
  summarise(
    gar_r2_score = quantile.r2.score(
    realized_estimates = GDP_actual,
    forecast_values = GaR_forecast,
    quantile = as.numeric(Quantile[1]),
    benchmark_values = Intercept_Forecast),
    macro_r2_score = quantile.r2.score(
    realized_estimates = GDP_actual,
    forecast_values = Macro_Forecast,
    quantile = as.numeric(Quantile[1]),
    benchmark_values = Intercept_Forecast))

rm(gar_macro_r2_df)

```


```{r gar_staff_r_squared}

gar_staff_r2_df = forecast_data_list[c("gar_forecast",
                                       "intercept_forecast")] %>% 
  map(~ filter(.,Forecast_Status == "Out of Sample") %>% 
        select(-Forecast_Status, -Date)) %>% 
  reduce(inner_join,
         by = c("Forecast_Period", "Horizon",
                "Quantile")) %>% 
  mutate(Quantile = str_replace_all(Quantile,"0.50","0.5")) %>% 
  inner_join(forecast_data_list$staff_forecast,
             by = c("Forecast_Period", "Horizon",
                "Quantile")) %>% 
  inner_join(forecast_data_list$actual_gdp_df,
             by = "Forecast_Period")

forecast_model_fit$gar_staff_r2 = gar_staff_r2_df %>% 
  group_by(Horizon, Quantile) %>% 
  summarise(
    gar_r2_score = quantile.r2.score(
    realized_estimates = GDP_actual,
    forecast_values = GaR_forecast,
    quantile = as.numeric(Quantile[1]),
    benchmark_values = Intercept_Forecast),
    staff_r2_score = quantile.r2.score(
    realized_estimates = GDP_actual,
    forecast_values = Staff_Forecast,
    quantile = as.numeric(Quantile[1]),
    benchmark_values = Intercept_Forecast))

rm(gar_staff_r2_df)

```

\subsection{Forecast accuracy}

We use out of sample comparison in order to test the robustness of partition specification. The out of sample forecast is constructed by estimation of a rolling window of length `r forecast_parameters$win_len` and forecasting `r forecast_parameters$out_of_sample_step` step ahead.

\subsection{Comparison to actual GDP}

We take actual GDP YoY growth rates and compare them with the predicted median YoY GDP growth rates. The matching between the actual and forecasted values is based on
forecasted period

```{r plot_gar_actual_rmse, eval=FALSE}

ggplot(forecast_model_fit$gar_actual_rmse,
       aes(x = reorder(Horizon, as.numeric(Horizon)), y = RMSE, fill = Horizon)) + 
  facet_grid(rows = vars(Forecast_Status), cols = vars(Win_Type), scales = "free_y") + 
  geom_col(width = 0.5) + 
  labs(x = "", y = "", title = "Forecast fit - RMSE") + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.1)) + 
  theme_bw() + 
  theme(legend.position = "bottom")

```


```{r plot_actual_quantile_fit_score, eval=FALSE}


ggplot(forecast_model_fit$gar_actual_fit_score %>% 
  group_by(Horizon,Win_Type,Forecast_Status) %>% 
  summarise(SD = mean(Score, na.rm = TRUE), .groups = "drop"),
  aes(x = Horizon, y = SD, fill = Horizon)) + 
  facet_grid(rows = vars(Forecast_Status), cols = vars(Win_Type), scales = "free_y") + 
  geom_col(width = 0.5) + 
  labs(x = "", y = "",
       title = "Forecast fit - average quantile fit score") + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.1)) + 
  theme_bw() + 
  theme(legend.position = "bottom")


```



\section{Comparison to staff forecast}

```{r gar_vs_staff_R2, fig.height=8}

ggplot(forecast_model_fit$gar_staff_r2 %>% 
         pivot_longer(cols = c(gar_r2_score,staff_r2_score),
                      names_to = "Model",values_to = "score") %>% 
         mutate(Model = str_remove_all(Model,"_r2_score")),
     aes(x = Quantile, y = score, fill = Model)) + 
  geom_col(position = "dodge", width = 0.3) + 
  scale_fill_viridis_d(labels = c("GaR", "Staff")) + 
  facet_wrap(~Horizon,nrow = 3, scales = "free_y") + 
  labs(x = "Quantile", y = "",
       title = paste0("GaR vs Staff \n ",
                      "(comparison by quantile R squared)")) + 
  theme_bw() + 
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank())



```



\section{Comparison to domestic macro}


```{r gar_vs_macro_R2, fig.height=8}

ggplot(forecast_model_fit$gar_macro_r2 %>% 
         pivot_longer(cols = c(gar_r2_score,macro_r2_score),
                      names_to = "Model",values_to = "score") %>% 
         mutate(Model = str_remove_all(Model,"_r2_score")),
     aes(x = Quantile, y = score, fill = Model)) + 
  geom_col(position = "dodge", width = 0.3) + 
  scale_fill_viridis_d(labels = c("GaR", "Macro vars only")) + 
  facet_wrap(~Horizon,nrow = 3, scales = "free_y") + 
  labs(x = "Quantile", y = "",
       title = paste0("GaR vs Macro only \n ",
                      "(comparison by quantile R squared)")) + 
  theme_bw() + 
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank())



```



\section{Residuals analysis}
