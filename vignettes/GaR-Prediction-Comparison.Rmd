
```{r load_prediction_libraries}

library(stargazer)

```


```{r set_forecast_parameters}

forecast_parameters = list(win_len = 30, out_of_sample_step = 1)

```


```{r make_actual_gdp_df}

actual_gdp_df = df %>% 
  select(Date, GDP) %>% 
  filter(complete.cases(.)) %>% 
  rename(GDP_actual = GDP) %>% 
  mutate(Forecast_Period = paste(Date - 1, Date, sep = "-")) %>% 
  select(-Date)
```


```{r GaR_forecast}

gar_forecast_df = lapply(c("fixed","expanding"),
                         function(temp_win_type){
  
  temp_res = get.gar.forecast(
    gar_obj = results,
    win_len = forecast_parameters$win_len,
    quantile_vec = parameters_list$quantile_vec,
    out_of_sample_step = forecast_parameters$out_of_sample_step,
    win_type = temp_win_type) %>% 
    filter(complete.cases(.)) %>% 
    mutate(Win_Type = temp_win_type)
  
  return(temp_res)
}) %>% 
  bind_rows() %>% 
  mutate(Date = as.yearqtr(Date))



```


\section{Residuals analysis}

```{r error_timeseries_plot, fig.width=8, fig.height=8, eval=FALSE}

ggplot(gar_forecast_df, aes(x = Date, y = Error)) + 
  geom_point() + 
  geom_line() + 
  geom_hline(yintercept = 0, color = "blue", linetype = "dashed") + 
  facet_grid(rows = vars(Horizon), cols = vars(Forecast_Status), scales = "free") + 
  labs(title = "Errors scatter plot", x = "", y = "") + 
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5))

```


```{r actual_vs_predicted_plot, fig.width=8, fig.height=8, eval=FALSE}

ggplot(gar_forecast_df, aes(x = GaR_actual, y = GaR_forecast)) + 
  geom_point() + 
  geom_abline(slope = 1, color = "blue", linetype = "dashed") + 
  facet_grid(rows = vars(Horizon), cols = vars(Forecast_Status), scales = "free") + 
  labs(title = "Actual vs predicted scatter plot") + 
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5))


```


```{r error_vs_predicted_plot, fig.width=8, fig.height=8, eval=FALSE}

ggplot(gar_forecast_df, aes(x = GaR_forecast, y = Error)) + 
  geom_point() + 
  geom_hline(yintercept = 0, color = "blue", linetype = "dashed") +
  facet_grid(rows = vars(Horizon), cols = vars(Forecast_Status), scales = "free") + 
  labs(title = "Predicted vs error scatter plot") + 
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5))


```


\subsection{Forecast accuracy}

We use in sample and out of sample comparison in order to test the robustness of partition
specification. The out of sample forecast is constracted by estimation of a rolling window of length
`r forecast_parameters$win_len` and forecasting `r forecast_parameters$out_of_sample_step` step ahead.

\subsection{Comparison to actual GDP}

We take the predicted YoY GDP growth rates and compare them with actual
GDP YoY growth rates. That basicaly means looking at the residual
(difference between actual and predicted) values of the qunatile regression.

\section{Comparison to staff forecast}

```{r, make_staff_forecast}

staff_forecast_df_h1 = raw_df %>% 
  select(Date, staff_1Q) %>% 
  rename_all(.funs = list(~str_remove(.,"staff_"))) %>% 
  gather(key = Quarter,value = Forecast, - Date) %>% 
  filter(complete.cases(.)) %>% 
  left_join(.,raw_df %>% 
              select(Date, GDP) %>% 
              mutate(GDP = GDP / lag(GDP,3) - 1)) %>% 
  mutate(Staff_Forecast = Forecast * 0.25 * 0.01 + GDP) %>% 
  select(Date,Staff_Forecast) %>% 
  mutate(Forecast_Period = paste(Date - 0.75,Date + 0.25, sep = "-")) %>% 
  mutate(Horizon = "1")

staff_forecast_df_h8 = raw_df %>% 
  select(Date, staff_5Q, staff_6Q, staff_7Q, staff_8Q) %>% 
  rename_all(.funs = list(~str_remove(.,"staff_"))) %>% 
  gather(key = Quarter,value = Forecast, - Date) %>% 
  group_by(Date) %>% 
  summarise(Staff_Forecast = mean(Forecast) * 0.01) %>% 
  ungroup() %>% 
  filter(complete.cases(.)) %>% 
  mutate(Forecast_Period = paste((Date + 1),(Date + 2), sep = "-")) %>% 
  mutate(Horizon = "8")

staff_forecast = bind_rows(staff_forecast_df_h1,
                           staff_forecast_df_h8) %>% 
  mutate(Date = as.yearqtr(Date)) %>% 
  inner_join(.,actual_gdp_df, by = "Forecast_Period") %>% 
  mutate(Error_staff = GDP_actual - Staff_Forecast)

rm(staff_forecast_df_h8, staff_forecast_df_h1)



```


```{r make_comparison_between_staff_and_gar_forecast}

gar_staff_comparison_df = gar_forecast_df %>% 
  filter(Quantile == "0.50") %>% 
  mutate(Forecast_Period = paste(Date + as.numeric(Horizon) * 0.25 - 1,
                                  Date + as.numeric(Horizon) * 0.25,
                                  sep = "-")) %>% 
  inner_join(.,actual_gdp_df, by = "Forecast_Period") %>% 
  mutate(Error_GaR = GDP_actual - GaR_forecast) %>% 
  select(-Quantile)

gar_staff_comparison_df = gar_staff_comparison_df %>% 
  inner_join(., staff_forecast %>% 
              select(-GDP_actual),
            by = c("Date","Horizon", "Forecast_Period"))

```


```{r plot}

ggplot(gar_staff_comparison_df %>% 
         filter(Forecast_Status == "Out of Sample") %>% 
         select(Date,Horizon,Win_Type,Error_GaR,Error_staff) %>% 
         gather(key = Method, value = Error, -Date,-Horizon,-Win_Type),
       aes(x = Date, y = Error, color = Method)) + 
  geom_point() + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "blue") + 
  labs(x = "", y = "", title = "Forecast difference \n (GaR - Staff)") + 
  facet_grid(rows = vars(Horizon),cols = vars(Win_Type),scales = "free") + 
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom")

```


```{r compare_forecast}

rmse_df = gar_staff_comparison_df %>% 
  filter(Forecast_Status == "Out of Sample") %>% 
  select(Date,Horizon,Win_Type,Error_GaR,Error_staff) %>% 
  gather(key = Method, value = Error, -Date,-Horizon,-Win_Type) %>%
  group_by(Win_Type, Horizon, Method) %>% 
  summarise(RMSE = sqrt(mean(Error ^ 2))) %>% 
  ungroup()

ggplot(rmse_df, aes(x = Method, y = RMSE  * 100, fill = Method)) + 
  geom_col(position = "dodge", width = 0.4) + 
  facet_grid(rows = vars(Horizon),cols = vars(Win_Type),scales = "free") + 
  labs(x = "", y = "RMSE(%)", title = "GaR vs Staff forecast fit") +
  theme_bw() + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))




```

