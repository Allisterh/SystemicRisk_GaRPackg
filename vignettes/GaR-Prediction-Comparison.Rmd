
```{r load_prediction_libraries}

library(stargazer)

```


```{r set_forecast_parameters}

theme_set(theme_bw())

forecast_parameters = list(
  win_len = 40,
  win_type_expanding = TRUE,
  df = df %>% filter(Date < as.yearqtr("2020Q1"))
    )

forecast_comparisons = list()

forecast_data_list = list()

forecast_model_fit = list()

```


<!-- Forecasts: GaR, staff, Macro -->


```{r make_df}

realized_df = forecast_parameters$df %>% 
  select(Date, GDP) %>% 
  filter(complete.cases(.)) %>% 
  rename(realized = GDP) %>% 
  mutate(Forecast_Period = paste(Date - 1, Date, sep = "-")) %>% 
  select(-Date) %>% 
  select(Forecast_Period, realized) %>% 
  as_tibble()

benchmark_df = get.gar.forecast(
  partitions_list = NULL,
  vars_df = forecast_parameters$df,
  target_var_name = "GDP",
  horizon_list = parameters_list$horizon_list,
  quantile_vec = parameters_list$quantile_vec,
  win_len = forecast_parameters$win_len,
  win_type_expanding = forecast_parameters$win_type_expanding) %>%          mutate(Forecast_Period = paste(
    Date + as.numeric(Horizon) * 0.25 - 1,
    Date + as.numeric(Horizon) * 0.25,
    sep = "-"
    )) %>%
  mutate(Horizon = as_factor(Horizon)) %>% 
  rename(benchmark = GaR_forecast)

staff_forecast_df = import.staff.forecast(raw_df = raw_df) %>% 
  as_tibble() %>% 
  rename(prediction = Staff_Forecast)

staff_forecast_df = list(
  name = "Staff",
  partition = list(staff = NA),
  pred_df = staff_forecast_df) %>% 
  enframe() %>% 
  pivot_wider()

```



```{r GaR_Forecast}

models_df = list(GaR_Forecast = partitions_list$basic,
                 Macro_Forecast = partitions_list$macro) %>% 
  enframe(value = "partition")

models_df = models_df %>%
  mutate(pred_df = map(partition,function(temp_part){
      temp_forecast = get.gar.forecast(
        partitions_list = temp_part,
        vars_df = forecast_parameters$df,
        target_var_name = "GDP",
        horizon_list = parameters_list$horizon_list,
        quantile_vec = parameters_list$quantile_vec,
        pca.align.list = list(
          Dom_FCI = list(var_name = "Spread_CPI_corp",
                         positive_direction = FALSE),
          Dom_Macro = list(var_name = "GDP"),
          Global = list(var_name = "gdp_us"),
          FinCycle = list(var_name = "Credit")
        ),
        win_len = forecast_parameters$win_len,
        win_type_expanding = forecast_parameters$win_type_expanding)
      
      temp_forecast = temp_forecast %>% 
        filter(complete.cases(.)) %>%
        mutate(Forecast_Period = paste(
          Date + as.numeric(Horizon) * 0.25 - 1,
          Date + as.numeric(Horizon) * 0.25,
          sep = "-"
        )) %>%
        mutate(Horizon = as_factor(Horizon)) %>% 
        rename(prediction = GaR_forecast)
        
        
      return(temp_forecast)
      
      }))

models_df = models_df %>% 
  rbind(staff_forecast_df)


models_df = models_df %>% 
  mutate(realized = map(1:nrow(.),~realized_df)) %>% 
  mutate(benchmark = map(1:nrow(.),~benchmark_df))

```

\subsection{Fan charts}


```{r calculate_scores}

models_df = models_df %>% 
  mutate(
    r2_score = pmap(.l = list(pred_df,realized, benchmark),
                     .f = function(pred_df,realized, benchmark){
                       temp_score = collect_quantile_r2_score(
                         pred_df = pred_df,
                         realized_df = realized,
                         benchmark_df = benchmark)
                       return(temp_score)
                     })
    ) %>% 
  mutate(
    pit_score = pmap(.l = list(pred_df,realized),
                     .f = function(pred_df,realized){
                       temp_score = pred_df %>% 
                         inner_join(realized_df,
                                    by = "Forecast_Period") %>% 
                         rename(actual_values = realized,
                                predicted_values = prediction) %>% 
                         quantile.pit.score()
                       
                       return(temp_score)
                     }))

```


<!-- Model fit evaluation -->

The model fit evaluation which is performed according to quantile $R^{2}$.


```{r plot_r2_goodness_of_fit}

models_df %>% 
  select(name, r2_score) %>% 
  unnest(r2_score) %>% 
  mutate(name = map_chr(name,~.)) %>% 
  ggplot(aes(x = Quantile, y = score, fill = name)) + 
  geom_col(position = "dodge") + 
  xlab(NULL) + ylab(NULL) + ggtitle("Quantile R2 score") + 
  scale_fill_viridis_d(option = "plasma") + 
  facet_wrap(~Horizon) + 
  theme(legend.position = "bottom", legend.title = element_blank())
```



```{r plot_pit_goodness_of_fit}

models_df %>% 
  select(name, pit_score) %>% 
  unnest(pit_score) %>% 
  mutate(name = map_chr(name,~.)) %>% 
  mutate(Quantile = as.numeric(Quantile)) %>% 
  ggplot(aes(x = Quantile, y = pit, group = name, color = name)) + 
  geom_line() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") + 
  xlab(NULL) + ylab(NULL) + ggtitle("PIT score") + 
  scale_color_viridis_d(option = "plasma") + 
  scale_x_continuous(breaks = c(0.05,0.25,0.5,0.75,0.95),
                   labels = c(0.05,0.25,0.5,0.75,0.95)) +
  facet_wrap(~Horizon) + 
  theme(legend.position = "bottom", legend.title = element_blank())

```

