
```{r get_predict_df}

predict_df = lapply(names(results$quantile_reg),
                               function(temp_name){

    temp_forecast = predict(results$quantile_reg[[temp_name]],
                       newdata = results$reg_df)
    
    temp_forecast  = temp_forecast %>% 
      as.data.frame() %>% 
      mutate(Date = results$reg_df$Date) %>% 
      setNames(str_remove_all(names(.),"tau= ")) %>% 
      gather(key = Quantile,value = GaR,-Date) %>% 
      mutate(Horizon = temp_name)
    
    return(temp_forecast)
  
}) %>% 
  bind_rows() %>% 
  mutate(Date = as.yearqtr(Date)) %>% 
  mutate(Horizon = factor(Horizon, levels = c("1","8","12"))) %>% 
  mutate(Quantile = str_replace(Quantile,"0.50","0.5"))

```


```{r plot_gar_timeseries}


ggplot(predict_df %>% 
         filter(Quantile == "0.05"),
       aes(x = Date, y = GaR, color = Horizon)) + 
  geom_line() + 
  scale_x_yearqtr() + 
  labs(title = "GaR (5% quantile) timeseries at different horizons",
       x = "", y = "") + 
  theme_bw() + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

```


```{r plot_gar_bounds_timeseries, fig.height=10}

temp_df = predict_df %>% 
  filter(Quantile %in% c("0.05","0.5","0.95")) %>% 
  spread(key = Quantile,value = GaR) %>% 
  mutate(`0.05`= `0.05`- `0.5`, `0.95` = `0.95` - `0.5`) %>% 
  gather(key = Quantile,value = GaR,-Date, -Horizon)

ggplot(predict_df %>% 
  filter(Quantile %in% c("0.05","0.5","0.95")),
       aes(x = Date, y = GaR, color = Quantile)) + 
  geom_line() + 
  scale_x_yearqtr() + 
  labs(title = "GaR upper and lower quantile timeseries", x = "", y = "") + 
  facet_wrap(~Horizon,ncol = 1) + 
  theme_bw() + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

```


```{r fan_chart}

gdp_df = df %>% 
  select(Date, GDP) %>% 
  filter(complete.cases(.)) %>% 
  filter(Date >= as.yearqtr("2018 Q1"))

fan_chart_df  = predict_df %>% 
  filter(Date == max(Date))%>% 
  spread(key = Quantile,value = GaR) %>% 
  rename_at(vars(-Date,-Horizon),
            .funs = list(~paste0("Q_",.))) %>% 
  mutate(Date = Date + as.numeric(as.character(Horizon)) * 0.25) %>% 
  select(-Horizon)
 

temp = fan_chart_df[nrow(fan_chart_df),]
temp$Date = gdp_df$Date[nrow(gdp_df)]
temp[,-1] = gdp_df$GDP[nrow(gdp_df)]

fan_chart_df = fan_chart_df %>% 
  rbind.data.frame(temp)

ggplot() +
  geom_line(data = gdp_df,
            aes(x = Date, y = GDP)) +
  geom_ribbon(data = fan_chart_df, aes(x = Date, ymin = Q_0.05, ymax = Q_0.95),
              fill = "lightblue",
              alpha = 0.6) +
   geom_ribbon(data = fan_chart_df, aes(x = Date, ymin = Q_0.25, ymax = Q_0.75),
              fill = "lightblue",
              alpha = 0.5) +
  geom_line(data = fan_chart_df, aes(x = Date, y = Q_0.5), color = "white") +
  labs(x = "", y = "",title = "Fan chart for GDP YoY growth rate") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.5)) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

rm(temp, gdp_df)


```

