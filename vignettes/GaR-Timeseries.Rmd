

```{r get_predict_df}


predict_df = lapply(names(results$qreg_result),
                               function(temp_name){

    temp_forecast = predict(results$qreg_result[[temp_name]],
                       newdata = results$reg_df)
    
    temp_forecast  = temp_forecast %>% 
      as.data.frame() %>% 
      mutate(Date = results$reg_df$Date) %>% 
      setNames(str_remove_all(names(.),"tau= "))
    
    temp_forecast[,!colnames(temp_forecast) == "Date"] = t(apply(
      temp_forecast[,!colnames(temp_forecast) == "Date"],1,sort))
    
      temp_forecast = temp_forecast %>% 
        gather(key = Quantile,value = GaR,-Date) %>% 
        mutate(Horizon = temp_name)
    
    return(temp_forecast)
  
}) %>% 
  bind_rows() %>% 
  mutate(Date = as.yearqtr(Date)) %>% 
  mutate(Horizon = factor(Horizon, unique(Horizon))) %>% 
  mutate(Quantile = str_replace(Quantile,"0.50","0.5"))


gar_factors_df = lapply(
  names(results$qreg_result),function(temp_name){
    
    gar_factors_df = results$reg_df %>%
      select(paste0(names(current_partition),"_xreg")) %>%
      as.matrix() * coefficients(
        results$qreg_result[[temp_name]])[-1,1]
    
    gar_factors_df = cbind(Date = results$reg_df$Date,
                           as.data.frame(gar_factors_df)) %>% 
      mutate(Horizon = temp_name)
    
    return(gar_factors_df)
 
                        })

names(gar_factors_df) = names(results$qreg_result)


```


```{r plot_gar_timeseries}

ggplot(predict_df %>% 
         filter(Quantile == "0.05"),
       aes(x = Date, y = GaR, color = Horizon)) + 
  geom_line() + 
  scale_x_yearqtr() + 
  labs(title = "GaR (5% quantile) timeseries at different horizons",
       x = "", y = "") + 
  theme_bw() + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

```


```{r plot_factor_contribution}

gar_factor_plot_list = lapply(names(gar_factors_df), function(temp_name){
  
  
  plot_df = gar_factors_df[[temp_name]] %>% 
  gather(key = Partition, value = GaR, -Date, -Horizon)

temp_plot = ggplot() + 
  geom_col(data = plot_df, mapping = aes(x = Date, y = GaR,
                                         fill = Partition),
           position = "stack", size = 5) +
  geom_line(data = plot_df %>%
              group_by(Date) %>%
              summarise(Total = sum(GaR),.groups = "drop") %>%
              ungroup(),mapping =  aes(x = Date, y = Total)) +
  scale_fill_viridis_d(option = "plasma") +
  labs(title = paste("Growth at risk partition decomposition",
                     "\n(at", temp_name, "Horizon)"),
       x = "", y = "") + 
  theme_bw() + 
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5))

  return(temp_plot)

})



```


```{r plot_gar_bounds_timeseries, fig.height=10}

ggplot(predict_df %>% 
  filter(Quantile %in% c("0.05","0.5","0.95")),
       aes(x = Date, y = GaR, color = Quantile)) + 
  geom_line() + 
  scale_x_yearqtr() + 
  labs(title = "GaR normalized upper and lower quantile timeseries",
       x = "", y = "") + 
  facet_wrap(~Horizon,ncol = 1) + 
  theme_bw() + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

```


```{r fan_chart}

gdp_df = df %>% 
  select(Date, GDP) %>% 
  filter(complete.cases(.)) %>% 
  filter(Date >= as.yearqtr("2018 Q1"))

fan_chart_df  = predict_df %>% 
  filter(Date == max(Date))%>% 
  spread(key = Quantile,value = GaR) %>% 
  rename_at(vars(-Date,-Horizon),
            .funs = list(~paste0("Q_",.))) %>% 
  mutate(Date = Date + as.numeric(as.character(Horizon)) * 0.25) %>% 
  select(-Horizon)
 

temp = fan_chart_df[nrow(fan_chart_df),]
temp$Date = gdp_df$Date[nrow(gdp_df)]
temp[,-1] = gdp_df$GDP[nrow(gdp_df)]

fan_chart_df = fan_chart_df %>% 
  rbind.data.frame(temp)

ggplot() +
  geom_line(data = gdp_df,
            aes(x = Date, y = GDP)) +
  geom_ribbon(data = fan_chart_df, aes(x = Date, ymin = Q_0.05, ymax = Q_0.95),
              fill = "lightblue",
              alpha = 0.6) +
   geom_ribbon(data = fan_chart_df, aes(x = Date, ymin = Q_0.25, ymax = Q_0.75),
              fill = "lightblue",
              alpha = 0.5) +
  geom_line(data = fan_chart_df, aes(x = Date, y = Q_0.5), color = "white") +
  labs(x = "", y = "",title = "Fan chart for GDP YoY growth rate") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.5)) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

rm(temp, gdp_df)

```

