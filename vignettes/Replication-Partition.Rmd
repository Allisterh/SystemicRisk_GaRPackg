---
output:
  rmarkdown::pdf_document:
    latex_engine: xelatex
    includes:
            in_header: C:\\Users\\Misha\\Documents\GaR\\GaR-preamble.tex

vignette: >
  %\VignetteIndexEntry{GaR analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF_8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, echo = FALSE, message = FALSE,warning = FALSE,
  comment = "#>"
)
```


```{r init_setup}

devtools::load_all()

library(GaRPackg)

# setwd("C:\\Users\\Misha\\Documents\\GaRPackg\\vignettes")
```


```{r load_libraries}

library(xts)

library(tidyselect)

library(ggplot2)

library(cowplot)

library(mFilter)

library(quantreg)

library(rlang)

```


<!-- Import data -->

```{r, child="Replication-Partition-ImportData.Rmd"}

```


<!-- Calculate partitons -->

```{r child="Replication-Partition-RunPartitions.Rmd"}

```


<!-- Run quantile regressions -->


```{r child="Replication-Partition-RunQuantileRegs.Rmd"}

```



<!-- Plot results -->

\section{Chained quantile regressions}

```{r make_plotlist__chained_quantile_coeffs}

plots_list = lapply(names(qregs_results$chained),
                 function(temp_horizon){
  
  coef_table = extract.qreg.coeff.table(qregs_results$chained[[temp_horizon]])
  
  plot = ggplot(coef_table %>% 
                mutate(Name = gsub(pattern = "estic",replacement = "",
                                   x = Name, fixed = TRUE)) %>%
                mutate(Name = factor(Name,
                                     levels = c("אאא","dom_fci",
                                                "leverage","external",
                                                "world_macro","world_fci",
                                                "Intercept"))) %>% 
                filter(!Name == "Intercept"),
              aes(x = Tau, y = Coeff, fill = Significant)) + 
  scale_fill_manual(values = c("Significant" = "blue",
                               "Non Significant" =  "lightblue")) + 
  geom_bar(stat = "identity", width = 0.2, position = "dodge") + 
  geom_hline(yintercept = 0, linetype = "dashed") + 
  facet_wrap(~Name) +
  labs(x = "Quantile", y = "",
       title = paste0("Quantile regression coefficients \n (",
                      temp_horizon, " quarters ahead)"), fill = "") + 
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.4),
        legend.position = "none")

  return(plot)
  
  
})

names(plots_list) = names(qregs_results$chained)


```


```{r plot_factor_contribution, eval = FALSE}

coef_mat = qregs_results$chained$`1`$coefficients %>% 
  as.data.frame(.) %>% 
  setNames(gsub("tau= ","",colnames(.))) %>% 
  mutate(Name = gsub("[()]","",rownames(.)))


ggplot(coef_mat %>% 
         select(Name, `0.05`) %>% 
         filter(!Name == "Intercept"), aes(x = Name, y = `0.05`)) + 
  geom_bar(stat = "identity") + 
  theme_bw()


```


```{r plot_5_percentile}

temp_df = data.frame(Category = c("Near Term", "Medium Term"),
           GaR = c(tail(qregs_results$chained$`1`$fitted.values[,1],1),
                   tail(qregs_results$chained$`8`$fitted.values[,1],1)))

# ggplot(temp_df,
#        aes(x = factor(Category, levels = c("Near Term", "Medium Term")),
#            y = GaR, group = 1)) + 
#   geom_line() + 
#   geom_point() + 
#   labs(x = "", y = "GDP (YoY) forecast",
#        title = paste0("Near and Medium term Risk",
#                                       "\n (5th percentile GaR)")) + 
#   theme_bw() + 
#   theme(panel.grid = element_blank(), plot.title = element_text(hjust = 0.5))


ggplot(temp_df,
       aes(x = factor(Category, levels = c("Near Term", "Medium Term")),
           y = GaR, group = 1)) + 
  geom_bar(stat = "identity", width = 0.25, fill = "orangered") + 
  geom_hline(yintercept = 0, linetype = "dashed") + 
  labs(x = "", y = "GDP (YoY) forecast",
       title = paste0("Near and Medium term Risk",
                                      "\n (5th percentile GaR)")) + 
  theme_bw() + 
  theme(panel.grid = element_blank(), plot.title = element_text(hjust = 0.5))



```


```{r plot_panel}

title_1q = paste0("Short-Term Quantile Regression Coefficients",
               " \n (1-Quarter Ahead)")

title_8q = paste0("Medium-Term Quantile Regression Coefficients",
               " \n (8-Quarter Ahead)")

p_row = plot_grid(plotlist = list(plots_list$`1` + labs(title = title_1q),
                                  plots_list$`8` + labs(title = title_8q)))

legend_row = get_legend(plots_list$`1` + theme(legend.position="bottom"))

plot_grid(p_row, legend_row ,ncol = 1, rel_heights = c(1, .2))

```



\section{Complete quantile regressions}

```{r plot_complete_quantile_coeffs, eval=FALSE}

invisible(sapply(names(qregs_results$complete), function(temp_horizon){
  
  coef_table = extract.qreg.coeff.table(qregs_results$complete[[temp_horizon]])
  
  plot = ggplot(coef_table %>% 
  mutate(Name = gsub(pattern = "estic",replacement = "",
                     x = Name, fixed = TRUE)) %>%
  mutate(Name = factor(Name,
                       levels = c("dom_macro","dom_fci",
                                  "leverage","external",
                                  "world_macro","world_fci",
                                  "Intercept"))) %>% 
    filter(!Name == "Intercept"),
       aes(x = Tau, y = Coeff, fill = Significant)) + 
  geom_bar(stat = "identity", width = 0.2, position = "dodge") + 
  geom_hline(yintercept = 0, linetype = "dashed") + 
  facet_wrap(~Name,scales = "free_y") +
  labs(x = "", y = "", title = paste("Quantile regression coefficients",
                                     temp_horizon, "ahead")) + 
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.4),
        axis.text.x = element_text(angle = 90),
        # axis.text.y = element_blank(), axis.ticks.y = element_blank(),
        legend.position = "bottom")
  
  print(plot)
  
  
}))





  
  

```


```{r get_timeseries_gar, eval=FALSE}

reg_df = make.quant.reg.df(chained_partitions_df = chained_partitions_df %>% 
                             select(-real_gdp_nis_y),
                           dep_var_df = chained_partitions_df %>% 
                             select(date, real_gdp_nis_y) %>% 
                             rename("GDP_growth" = real_gdp_nis_y),
                           horizon = 1)

reg_df = xts(x = reg_df %>% 
               select(-date),order.by = as.Date(reg_df$date))

temp = rollapply(reg_df, width = 31,FUN =  function(temp_reg_df){
  
  reg_df = temp_reg_df[1:10,]

  quant_reg = rq(formula = formula("GDP_growth~."),
               tau = 0.05,
               data = as.data.frame(coredata(reg_df)))
  
  return(predict(object = quant_reg,newdata = temp_reg_df[11,]))
  
  
},
by.column = FALSE)



```


```{r plot_time_series_gar, eval=FALSE}

ggplot(temp %>% 
         as.data.frame() %>% 
         mutate(Date = rownames(.)) %>% 
         setNames(c("GaR","Date")) %>% 
                    filter(complete.cases(.)),
       aes(x = Date, y = GaR, group = 1)) + 
  geom_line() +
  labs(x = "",y = "",
       title = "Timeseries of predicted GDP growth \n (5th quantile)") + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90),
        plot.title = element_text(hjust = 0.5))


```

