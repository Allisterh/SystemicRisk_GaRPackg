---
output:
  rmarkdown::pdf_document:
    latex_engine: xelatex
    includes:
            in_header: C:\\Users\\Misha\\Documents\GaR\\GaR-preamble.tex

vignette: >
  %\VignetteIndexEntry{GaR analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF_8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, echo = FALSE, message = FALSE,warning = FALSE,
  comment = "#>"
)
```


```{r init_setup}

devtools::load_all()

library(GaRPackg)
```


```{r load_libraries}

library(zoo)

library(tidyselect)

library(ggplot2)

library(cowplot)

library(mFilter)

library(quantreg)

library(rlang)

```


```{r Set_parameters}

partitions = list(domestic_macro = list('real_gdp_yoy',
                                        'industrial_prod_yoy','pmi',
                                        "cyclical_composite_yoy"),
                  domestic_fci = list('term_spread', 'corporate_spread',
                                      'interbank_spread','sovereign_spread',
                                      'securities_ba_spread',
                                      'equity_returns_qoq', 'policy_rate',
                                      'cpi_inflation', 
                                      'implied_yield_cpi_bond_yoy',
                                      'inflation_expectations',
                                      'fx_returns_qoq', 'fx_ba_spread',
                                      'equity_implied_vol'),
                  leverage = list('private_credit_gdp', 'loan_deposits_ratio',
                                  'tier1_rwa', 'npl_ratio', 'share_fx_loans',
                                  'nfc_debt_equity',
                                  'derivatives_assets_capital',
                                  'liquid_assets_st_liabilities',
                                  'net_fx_positions_capital'),
                  external = list('reer_yoy', 'ca_gdp', 'trade_gdp',
                                  'dom_investment_gdp'),
                  world_macro = list('world_real_gdp_yoy',
                                     'world_indus_prod_yoy'),
                  world_fci = list('vix', 'nasdaq_vol', 'nasdaq_returns_qoq',
                                   'oil_future_qoq','us_reer_eme_yoy'))


pls_target_list = list(domestic_macro = list("real_gdp_yoy", "pmi"),
                   domestic_fci = list("term_spread", "corporate_spread"),
                   leverage = list("private_credit_gdp"),
                   world_macro = list("world_real_gdp_yoy"),
                   world_fci = list("vix", "nasdaq_returns_qoq"))

```


```{r Import_data}

df = read.csv(paste0("C:\\Users\\Misha\\Documents\\GaR Python\\Israel",
                     " GaR\\Data\\Final\\final_data_israel.csv"),
              stringsAsFactors = FALSE) %>% 
  mutate(date = as.Date(date)) %>% 
  filter(date >= as.Date("1996-01-01") & date <= as.Date("2019-06-01"))

```


```{r get_pca_partitons}

partitions_df = lapply(partitions,function(temp_part){
  df %>% 
    select(unlist(temp_part), date) %>% 
    mutate_all(interpolate) %>% 
    chain_index()}) %>% 
  reduce(full_join, by = "Date") %>% 
  setNames(c("Date", names(partitions)))


partitions_df = left_join(df %>% 
                            select(date, real_gdp_nis_y),
                          partitions_df, by = c("date" = "Date"))
                

```


```{r get_quantile_regressions}

reg_df = make.quant.reg.df(partitions_df = partitions_df %>% 
                             select(-real_gdp_nis_y),
                           dep_var_df = partitions_df %>% 
                             select(date, real_gdp_nis_y) %>% 
                             rename("GDP_growth" = real_gdp_nis_y),
                           horizon = 1)

qreg_list = rq(formula = formula("GDP_growth~."),
               tau = c(0.05,0.25,0.5,0.75,0.95),
               data = as.data.frame(scale(reg_df %>% 
                                            select(-date))))


```


```{r plot_quantile_coeffs}

coef_table = lapply(suppressWarnings(summary(qreg_list)),
                    function(temp_list){
                      
                      temp_df = as.data.frame(temp_list$coefficients)
                      
                      temp_df$tau = temp_list$tau
                      
                      temp_df$Name = rownames(temp_df)
                      
                      rownames(temp_df) = NULL
                      
                      return(temp_df)
                      
                    }) %>% 
  bind_rows() %>% 
  rename(Coeff = coefficients, Low = `lower bd`,
         High = `upper bd`, Tau = tau) %>% 
  mutate(Tau = as.character(Tau)) %>% 
  mutate(Name = gsub("(Intercept)","Intercept",Name, fixed = TRUE)) %>% 
  mutate(Significant = ifelse(High <= 0 | Low >= 0,TRUE, FALSE))


ggplot(coef_table %>% 
  mutate(Name = gsub(pattern = "estic",replacement = "",
                     x = Name, fixed = TRUE)) %>%
  mutate(Name = factor(Name,
                       levels = c("dom_macro","dom_fci",
                                  "leverage","external",
                                  "world_macro","world_fci",
                                  "Intercept"))) %>% 
    filter(!Name == "Intercept"),
       aes(x = Tau, y = Coeff, fill = Significant)) + 
  geom_bar(stat = "identity", width = 0.2, position = "dodge") + 
  geom_hline(yintercept = 0, linetype = "dashed") + 
  facet_wrap(~Name,scales = "free_y") +
  labs(x = "", y = "", title = "Quantile regression coefficients") + 
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.4),
        axis.text.x = element_text(angle = 90),
        axis.text.y = element_blank(), axis.ticks.y = element_blank(),
        legend.position = "bottom")
  
  

```

