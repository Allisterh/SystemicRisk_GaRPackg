---
title: "Inflation at Risk: The Distribution of Future Inflation in Israel"
author: "Michael Gurkov and Osnat Zohar"
institute: "Bank of Israel \\newline Research Department \\newline \\newline Any views expressed in the Discussion Paper are those of the authors and do not necessarily reflect those of the Bank of Israel"
date: "16 June, 2021"
classoption: t
output:
  beamer_presentation:
    includes:
      in_header: !expr here::here('vignettes/GaR-PresentationPreamble.tex')
    latex_engine: xelatex
    slide_level: 2
# bibliography: "GaR.bib"
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, echo = FALSE, message = FALSE,
  warning = FALSE, comment = "#>"

)
```


```{r init_setup}

devtools::load_all()

library(ggcorrplot)

library(mFilter)

library(tidyverse)

library(lubridate)

library(slider)

library(cowplot)

library(broom)

library(gghighlight)

setwd(paste0(
  file.path(Sys.getenv("USERPROFILE"),fsep = "\\"),
  "\\Documents\\GaRPackg\\vignettes"))


```



```{r set_params}

partitions_list = list(
  inflation = c("cpi"),
  exchange_rate = c("nis_usd"),
  oil_p = c("brent_usd"),
  output_gap = c("meshulav_gap")
)



horizon_list=c(12)

quantile_vec=c(0.10,0.25,0.5,0.75,0.90)



theme_set(theme_bw() + 
            theme(title = element_text(size = 20),
                axis.text = element_text(size = 15),
                axis.title = element_text(size = 15),
                strip.text = element_text(size = 15),
                legend.position = "bottom",
                legend.title = element_blank(),
                legend.text = element_text(size = 15)))

# plot_names = tribble(
#   ~var_name, ~plot_name,
#   "Intercept", "Intercept",
#   "cpi", "Inflation",
#   "cpi_lag", "Inflation",
#   "spf1y","Expectations",
#   "beir5y5y","LT Expect.",
#   "nis_usd", "Exchange Rate",
#   "rel_tradables", "Tradables",
#   "brent_usd", "Oil Prices",
#   "meshulav_gap","Output Gap"
# )



```

```{r load_data}

raw_df = import_from_fame_template(
  paste0(
    file.path(Sys.getenv("USERPROFILE")),
    "\\OneDrive - Bank Of Israel\\Data\\BoI\\IaR_data\\data_Inflation_at_Risk_monthly.csv"
  ),data_frequency = "monthly"
)

df = raw_df %>% 
  mutate(rel_tradables = cpi_tradables / cpi_nontradables_excl_fv_hous) %>%
  preprocess_df(
    vars_to_yoy = c(
      "cpi",
      "cpi_excl_fv",
      "cpi_excl_fv_hous",
      "cpi_excl_hous",
      "rel_tradables",
      "cpi_oecd",
      "cpi_us",
      "cpi_euro",
      "debt_business",
      "debt_households",
      "house_price",
      "ta125"
    ),
    vars_to_percent_changes = c("nis_usd",
                                "neer",
                                "brent_usd",
                                "brent_nis",
                                "non_energy_p"),
    convert_to_percent_units = TRUE
  ) %>%
  mutate(target = target * 100) %>% 
  mutate(cpi_orig = cpi) %>% 
  mutate(cpi = cpi_excl_fv_hous) %>% 
  mutate(cpi_lag = lag(cpi)) %>% 
  filter(year(date) >= 2004 & year(date) <= 2019)

filter_obj =  hpfilter(df$madad_meshulav,freq = 1600)

df = df %>% 
  mutate(meshulav_gap = filter_obj$cycle / filter_obj$trend[,1] * 100)


```

```{r run_analysis}

iar_analysis = run_GaR_analysis(
  partitions_list = partitions_list,
  vars_df = df,
  target_var_name = "cpi",
  horizon_list = horizon_list,
  quantile_vec = quantile_vec,
  pca.align.list = list(
    output_gap = list("output_gap", TRUE),
    expect = list("beir1y", TRUE)
  )
)

ols_coeffs = iar_analysis$reg_df %>% 
  select(cpi_12, ends_with("xreg")) %>% 
  lm("cpi_12 ~ .",.) %>% 
  tidy() %>% 
  filter(!term == "(Intercept)") %>% 
  mutate(term = str_remove_all(term, "_xreg")) %>% 
  mutate(partition = factor(term,
                       levels = c("nis_usd","cpi","brent_usd","meshulav_gap"),
                       labels = c("Exchange Rate","Inflation","Oil prices",
                                       "Output Gap"))) %>% 
  select(partition, estimate)


```

```{r out_of_sample_forecast}

win_len = 85

iar_forecast = get_gar_forecast(partitions_list = partitions_list,
                                vars_df = df,
                                target_var_name = "cpi",
                                horizon_list = horizon_list,
                                quantile_vec = quantile_vec,
                                win_len = win_len,
                                win_type_expanding = TRUE)

intercept_forecast = get_gar_forecast(partitions_list = NULL,
                                vars_df = df,
                                target_var_name = "cpi",
                                horizon_list = horizon_list,
                                quantile_vec = quantile_vec,
                                win_len = win_len,
                                win_type_expanding = TRUE)

inflation_forecast = get_gar_forecast(partitions_list = list(inflation = "cpi"),
                                vars_df = df,
                                target_var_name = "cpi",
                                horizon_list = horizon_list,
                                quantile_vec = quantile_vec,
                                win_len = win_len,
                                win_type_expanding = TRUE)

rm(win_len)


```


## Outline

\tableofcontents[sectionstyle=show/show,subsectionstyle=hide/hide]

## Motivation

\begin {itemize}
\itemsep3em
	\item
	Analyzing the distribution of future inflation in the "post" disinflation
	period.
	\item
	We provide a methodological tool for assessing risks to inflation in Israel
	using Philips curve specification:

	\vspace{1em}

\begin{center}
\begin{block}{}

	Given current Philips curve "state", what is the distribution of
	expected inflation?

\end{block}
\end{center}

\end{itemize}


## Motivation

```{r plot_inf_rates}

df %>% 
  select(date, cpi) %>% 
  mutate(cpi_ma = slide_dbl(cpi,mean,.before = 48,.complete = TRUE)) %>% 
  mutate(cpi_var = slide_dbl(cpi,var,.before = 48,.complete = TRUE)) %>% 
  pivot_longer(-date) %>% 
  ggplot(aes(x = date, y = value, color = name)) + 
  geom_line() + 
  scale_color_discrete(labels = c("CPI Inflation","CPI Moving Average (48 periods)",
                                "CPI Variance (48 periods)")) + 
  xlab(NULL) + ylab(NULL) + 
  ggtitle(paste0("Year-on-Year CPI Inflation Excluding Fruits,",
                 " Vegetables, and Housing (Monthly,2004-2019)"))


```

## The Inflation at Risk (IaR) Approach

\vspace{1em}

* IaR is a linear model of density forecasts
  + Based on quantile regression
  + Parsimonious
  + Easy to interpret

\vspace{1em}

* Based on Adrian et al. (2019), operationalized by Banerjee et al. (2020).

\vspace{1em}

* Applied to:
  + Advanced economies ()
  + Developing economies ()


## Contribution



## Main Results

\begin{itemize}
\setlength\itemsep{1.5em}
\item
In-sample properties of the distribution of expected inflation:
  \begin{enumerate}
	\item
	Balanced risk and stable uncertainty before 2011, decrease in uncertainty
	and (relative) increase in downside risks after
	\item
	Realized inflation is the predominant factor explaining the changes in the
	features of the forecast distribution.
	\item
	Oil prices and the exchange rate play an important role in the
	evolution of forecast uncertainty, the output gap explains variation in
	skewness.
  \end{enumerate}
\item
Out-of-sample forecast performance is similar to benchmark models.

  \begin{itemize}
    \item but IaR allows state-dependent evaluation of risks
  \end{itemize}
  
\end{itemize}






# Methodology and Estimation Results
## Methodology

\label{methodology}

\textbf{Quantile regressions --}
	estimate a forecast equation for each quantile $\tau$
	and horizon $h$:
	$$
	Q^{\tau}_{t,h}=\beta^{\tau}_hX_t+\epsilon^{\tau}_{t,h}
	$$

\vspace{0.5em}

	where: $X_t=[1, x^1_t, ... , x^K_t]$

\begin{flushright}
	\hyperlink{QuantileReg}{\beamerbutton{quantile reg}}
\end{flushright}



## Data Partitioning




## Persistent Inflation, Positive Oil Price and Negative Output Gap


```{r plot_coeffs, fig.height=7.5}

iar_analysis %>%
  extract_coeffs_from_gar_model() %>%
  filter(!partition == "Intercept") %>%
  mutate(partition = factor(
    partition,
    levels = c("nis_usd", "cpi", "brent_usd", "meshulav_gap"),
    labels = c("Exchange Rate", "Inflation", "Oil prices",
               "Output Gap")
  )) %>%
  ggplot(aes(x = quantile, y = coeff, fill = significant)) +
  geom_col(width = 0.3) +
  scale_fill_manual(
    values = c("significant" = "lightblue",
               "non_significant" = "gray"),
    labels = c("Significant", "Non significant")
  ) +
  facet_grid(rows = vars(partition), scales = "free") +
  geom_hline(
    aes(yintercept = estimate),
    data = ols_coeffs,
    color = "blue",
    linetype = "dashed"
  ) +
  geom_hline(yintercept = 0) +
  xlab("Quantile") + ylab(NULL) +
  labs(
    caption = paste0(
      "Notes: Each column shows the estimated coefficients ",
      "from the quantile regression at a specific forecast horizon. ",
      "\n  Blue bars mark coefficients that are significant at 10%",
      "(see Koenker, 1994)"
    )
  ) +
  theme(plot.caption = element_text(size = 10, hjust = 0.5),
        axis.text.x = element_text(size = 12),
        strip.text = element_text(size = 14)) +
  # theme_classic() +
  NULL

```


# In-sample Features of the Forecast Distribution
## IQR and median

```{r plot_dist_timeseries}

plot_df = iar_analysis$fitted_df %>%
  filter(quantile %in% c(0.25,0.5,0.75)) %>% 
  select(-horizon) %>% 
  group_by(date = as.yearqtr(date), quantile) %>% 
  summarise(avg_values = mean(fitted_values), .groups = "drop")

ggplot() + 
  geom_line(data = plot_df %>%
              filter(quantile == "0.5"), aes(x = date, y = avg_values)) +
  geom_ribbon(data = plot_df %>%
                filter(quantile %in% c(0.25,0.75)) %>%
                pivot_wider(names_from = "quantile",
                            names_prefix = "q_",
                            values_from = "avg_values"),
              aes(x = date, ymin = q_0.25, ymax = q_0.75), alpha = 0.5) +
  ylab("Percent") + xlab(NULL) +
  ggtitle("Quantiles of inflation")
 

```


## Risks to Inflation 

```{r plot_skewness_1_quarter, fig.height=7}

skew_df = iar_analysis %>%
  calculate_skew_and_iqr() %>%
  select(-horizon) %>% 
  pivot_longer(-date) %>% 
  group_by(date = as.yearqtr(date), name) %>% 
  summarise(value = mean(value), .groups = "drop") %>% 
  mutate(name = factor(name, levels = c("iqr","skew"),
                       labels = c("Dispersion","Skewness")))

mean_df = skew_df %>% 
  group_by(name) %>% 
  summarise(avg = mean(value))

 skew_df%>% 
  ggplot(aes(x = date, y = value)) +
  geom_line() +
  # geom_hline(aes(yintercept = mean(value)), color = "blue") + 
  facet_wrap(~name, scales = "free") + 
  geom_hline(aes(yintercept = avg), color = "blue", data = mean_df) + 
  # geom_hline(yintercept = c(-0.5,0.5), linetype = "dashed",
  #            color = "blue") +
  # geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  labs(x = "", y = "", title = "High Moments of the Forecast Distribution",
       caption = "Note: the dashed lines represent ± 2 standard error estimates") + 
  theme(plot.caption = element_text(hjust = 0.5))

 
 rm(skew_df, mean_df)

```

## Correlations

```{r cor_mat}

df %>% 
  select(date, unlist(partitions_list,use.names = FALSE)) %>% 
  left_join(iar_analysis %>% 
              calculate_skew_and_iqr() %>% 
              select(-horizon), by = "date") %>% 
  select(-date) %>% 
  cor() %>% 
  ggcorrplot(type = "lower",lab = TRUE)


```




## Realized Inflation is Dominant in Both Risk Metrics. \newline Output Gap also Dominant in Skewness

```{r plot_factor_decomposition}


factor_plot_data = iar_analysis %>%
  extract_factor_contribution_from_gar_model(target_quantile = "0.25") %>%
  mutate(quantile = 0.25) %>% 
  bind_rows(iar_analysis %>%
  extract_factor_contribution_from_gar_model(target_quantile = "0.75") %>%
  mutate(quantile = 0.75)) %>% 
  bind_rows(iar_analysis %>%
  extract_factor_contribution_from_gar_model(target_quantile = "0.5") %>%
  mutate(quantile = 0.5)) %>% 
  select(-horizon) %>% 
  pivot_longer(-c(date,quantile)) %>% 
  filter(!name == "intercept") %>% 
  pivot_wider(names_from = quantile,names_prefix = "q_") %>% 
  mutate(dispersion = q_0.75 - q_0.25) %>% 
  mutate(skewness = q_0.75 + q_0.25 - 2 * q_0.5) %>% 
  mutate(name = factor(name,
                       levels = c("cpi","nis_usd","brent_usd","meshulav_gap"),
                       labels = c("Inflation","Exchange Rate","Oil prices",
                                  "Output Gap")))


disp_plot = factor_plot_data %>% 
  ggplot(aes(x = date, y = dispersion, fill = name)) + 
  geom_col() + 
  xlab(NULL) + ylab(NULL) + ggtitle("Dispertion")

skew_plot = factor_plot_data %>% 
  ggplot(aes(x = date, y = skewness, fill = name)) + 
  geom_col() + 
  xlab(NULL) + ylab(NULL) + ggtitle("Skewness")

plot_legend = get_legend(disp_plot)

plots_row = plot_grid(disp_plot + 
            theme(legend.position = "none"),
          skew_plot + 
            theme(legend.position = "none"))

plot_grid(plots_row, plot_legend,nrow = 2,rel_heights = c(4,1))

rm(disp_plot, skew_plot, plot_legend, plots_row)


```


## Low Median Forecasts are Associated with Higher Uncertainty

```{r plot_median_iqr_scatter}

iar_analysis %>%
  calculate_skew_and_iqr() %>%
  inner_join(iar_analysis$fitted_df %>%
               filter(quantile == "0.5") %>%
               select(-quantile), by = c("date","horizon")) %>%
  mutate(horizon = factor(horizon, levels = c(1,4,8,12))) %>%
  ggplot(aes(x = iqr, y = fitted_values)) +
  geom_point() +
  geom_smooth(method = "lm") +
  xlab("Dispersion") + ylab("Median") +
  theme(axis.text = element_text(size = 8))


```

# Out-of-Sample Forecast Performance
## Out-of-Sample Forecast

```{r out_of_sample_forecast_plot}


ggplot() + 
  geom_line(data = iar_forecast %>%
              filter(quantile == "0.50") %>% 
              mutate(date = date + as.numeric(horizon)  / 12),
            aes(x = date, y = forecast_values )) +
  geom_line(data = df %>% 
              filter(date >= min(iar_forecast$date + 1)),
            aes(x = date, y = cpi), color = "red") +
  geom_ribbon(data = iar_forecast %>%
                filter(quantile %in% c(0.25,0.75)) %>%
                mutate(date = date + as.numeric(horizon)  / 12) %>%
                pivot_wider(names_from = "quantile",
                            names_prefix = "q_",
                            values_from = "forecast_values"),
              aes(x = date, ymin = q_0.25, ymax = q_0.75), alpha = 0.3,
              color = "lightgrey") +
  geom_ribbon(data = iar_forecast %>%
                filter(quantile %in% c("0.10","0.90")) %>%
                mutate(date = date + as.numeric(horizon)  / 12) %>%
                pivot_wider(names_from = "quantile",
                            names_prefix = "q_",
                            values_from = "forecast_values"),
              aes(x = date, ymin = q_0.10, ymax = q_0.90), alpha = 0.3,
              color = "grey") + 
  ylab("Percent") + xlab(NULL) +
  ggtitle("Quantiles of inflation")



```


## Out-of-Sample Forecast Performance

\vspace{2em}

\begin{itemize}
\setlength\itemsep{2em}
	\item
	IaR model compared to two alternatives:
	\begin{enumerate}
		\item
		Intercept only -- partial IaR model without explanatory variables
		\item
		Intercept and realized inflation -- partial IaR model
	\end{enumerate}
	\item
	The models are evaluated out of sample (expanding window starts at
	96 observations and adds one observation in each step)
\end{itemize}

## Goodness of fit -- PIT score \newline (the closer to the black line the better)

\label{PITscore}

```{r pit_score}

iar_pit = quantile_pit_score(
  forecast_df = iar_forecast,
  actual_df = select(df, actual_values = cpi, date),
  frequency = "monthly") %>%
  rename(iar = pit)

intercept_pit = quantile_pit_score(
  forecast_df = intercept_forecast,
  actual_df = select(df, actual_values = cpi, date),
  frequency = "monthly"
) %>%
  rename(intercept = pit)

inflation_pit = quantile_pit_score(
  forecast_df = inflation_forecast,
  actual_df = select(df, actual_values = cpi, date),
  frequency = "monthly"
) %>%
  rename(realized_inflation = pit)

list(iar_pit, intercept_pit, inflation_pit) %>%
  reduce(inner_join, by = c("quantile", "horizon")) %>%
  pivot_longer(-c("quantile", "horizon")) %>%
  mutate(quantile = as.numeric(quantile)) %>%
  mutate(name = factor(name,
                       levels = c("realized_inflation","iar","intercept"),
                       labels = c("CPI only","Inflation at risk","Intercept"))) %>% 
  ggplot(aes(x = quantile,y = value,color = name,group = name)) +
  geom_line() +
  geom_abline(
    slope = 1,
    intercept = 0,
    color = "black",
    linetype = "dashed"
  ) +
  xlim(0,1) + ylim(0,1) + 
  xlab("Quantile") + ylab(NULL)



```


\hyperlink{PIT}{\beamergotobutton{PIT}}

## Goodness of fit --Quantile R-Squared
Quantile R-sq. Giglio et al. (2016) compares forecast performance to a
intercept only quantile benchmark:

$$
R^2_{\tau,h} \equiv 1- \frac{\sum_{t} \left( y_{t+h} - \hat{Q}^{\tau}_{t,h} \right) \left(\tau - \mathbb{I}_{ \left\{ y_{t+h} - \hat{Q}^{\tau}_{t,h}>0 \right\} } \right) }{ \sum_{t} \left(y_{t+h} - \hat{c}^{\tau}_{t,h} \right) \left(\tau - \mathbb{I}_{ \left\{ y_{t+h} - \hat{Q}^{\tau}_{t,h}>0 \right\} } \right) }
$$

$\hat{Q}^{\tau}_{t,h}$  -- model's forecasts for quantile
$\tau$ at horizon $h$

$\hat{c}^{\tau}_{t,h}$ -- intercept only forecast


\begin{itemize}
	\item
	higher values -- better forecast
	\item
	negative values -- model inferior to the intercept only benchmark
\end{itemize}




## Goodness of fit --Quantile R-Squared \newline (the higher the better, negative means worse than intercept only)

```{r plot_r2_score}

iar_r2 = quantile_r2_score(
  forecast_df = iar_forecast,
  actual_df = select(df, actual_values = cpi, date),
  benchmark_df = intercept_forecast %>%
    rename(benchmark_values = forecast_values),
  frequency = "monthly"
) %>%
  rename(iar_r2 = quantile_r2)

inflation_r2 = quantile_r2_score(
  forecast_df = inflation_forecast,
  actual_df = select(df, actual_values = cpi, date),
  benchmark_df = intercept_forecast %>%
    rename(benchmark_values = forecast_values),
  frequency = "monthly"
  ) %>%
  rename(inflation = quantile_r2)

iar_r2 %>%
  inner_join(inflation_r2,by = c("horizon", "quantile")) %>%
  pivot_longer(-c(horizon, quantile)) %>%
  mutate(quantile = factor(quantile, levels = quantile_vec)) %>%
  ggplot(aes(x = quantile, y = value, fill = name)) +
  geom_col(position = "dodge") +
  scale_fill_discrete(labels = c("IaR","Inflation only")) +
  xlab("Quantile") + ylab(NULL)

```


# Summary

# Appendix {.unlisted .unnumbered}
## Probability Integral Transform (PIT)

\label{PIT}


For each quantile $\tau$ and horizon $h$, we compute  the percentage of observations that fall below the forecast quantile $\hat{Q}^{\tau}_{t,h}$:
	$$
	\varphi_{\tau,h} \equiv \frac{1}{T-h} \sum_{t=1}^{T-h} \mathbb{I}_{ \left\{ y_{t+h} <  \hat{Q}^{\tau}_{t,h} \right\} }.
	$$
\begin{itemize}
\setlength\itemsep{1em}
	\item
	A model is better fitted the closer $\varphi_{\tau,h}$ is to
	45-degree line.
	\item
	If the model perfectly fits the empirical  distribution, then
	the fraction of observations falling below quantile $\tau$
	should be exactly $\tau$, namely, $\varphi_{\tau,h}=\tau$.
\end{itemize}


\hyperlink{PITscore}{\beamergotobutton{PITscore}}

## Quantile Regression

\label{QuantileReg}

Model: for quantile $\tau$ and horizon $h$,
$$
Q^{\tau}_{t,h}=\beta^{\tau}_hX_t+\epsilon^{\tau}_{h,t}
$$

$\beta^{\tau}$ is  estimated by solving the minimization problem

$$
\min_{\beta^{\tau}}
\sum_{t=1}^T
\max \bigg\{
\tau \big( y_{t+h}- \beta^{\tau}X_t \big)
\, ,\,
(\tau-1) \big( y_{t+h}- \beta^{\tau}X_t \big)
\bigg\}
$$

Note: "Quantile crossing" handled using the method of Chernozhukov et al. (2010).

\begin{flushleft}
\hyperlink{methodology}{\beamergotobutton{Methodology}}
\end{flushleft}



