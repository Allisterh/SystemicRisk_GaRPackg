

```{r load_library}

library(devtools)

load_all()

```


```{r set_forecast_parameters}

theme_set(theme_bw())

forecast_parameters = list(
  win_len = 40,
  win_type_expanding = TRUE,
  df = df %>% filter(Date < as.yearqtr("2020Q1"))
    )

forecast_benchmarks = list()

forecast_data_list = list()

forecast_model_fit = list()

models_list = list(GaR_Forecast = partitions_list$basic_no_global_inf,
                   Intercept_Forecast = NULL,
                   Macro_Forecast = partitions_list$macro,
                   Basic_Forecast = partitions_list$two_features,
                   RealFin_Forecast = partitions_list$real_fin)


```


```{r make_actual_gdp_df}

forecast_benchmarks$actual_gdp_df = forecast_parameters$df %>% 
  select(Date, GDP) %>% 
  filter(complete.cases(.)) %>% 
  rename(GDP_actual = GDP) %>% 
  mutate(Forecast_Period = paste(Date - 1, Date, sep = "-")) %>% 
  select(-Date) %>% 
  select(Forecast_Period, GDP_actual)

```


```{r reg_dfs}


temp_models = tibble(model = names(models_list$GaR_Forecast))

temp_reg_df_list = map(models_list, function(temp_part){
  
  temp_df = make.quant.reg.df(
    partitions_list = temp_part,
    vars_df = df,
    target_var_name = "GDP",
    horizon_list = list(1,4,8,12)
    )
  
  temp_df = temp_df$reg_df  %>% 
    select(-contains("GDP"))
  
  
  
})

temp_reg_cor_df = map(
  names(models_list$GaR_Forecast),function(temp_name){
    
    temp_cor_df = map(names(temp_reg_df_list),
                      function(temp_reg_name){
      
      temp_df = temp_reg_df_list[[temp_reg_name]]
      
      temp_df = temp_df %>% 
        select(any_of(c("Date", temp_name)))
      
      if(temp_name %in% names(temp_df)){
        
        temp_df = temp_df %>% 
        rename(!!sym(temp_reg_name) := !!sym(temp_name))
        
        
      }

      return(temp_df)
      
      
    }) %>% 
  reduce(inner_join, by = "Date")
                      })

temp_reg_cor_df[[5]] %>% 
  select(-Date) %>% 
  cor()


    

```



```{r GaR_Forecast}

forecast_data_list = map(names(models_list),
  function(temp_name){
    
    temp_df = get.gar.forecast(
      partitions_list = models_list[[temp_name]],
      vars_df = forecast_parameters$df,
      target_var_name = "GDP",
      horizon_list = parameters_list$horizon_list,
      quantile_vec = parameters_list$quantile_vec,
      pca.align.list = list(
        Dom_FCI = list(
          var_name = "Spread_CPI_corp",
          positive_direction = FALSE),
        Dom_Macro = list(var_name = "GDP"),
        Global = list(var_name = "rate_euro"),
        FinCycle = list(var_name = "Credit")),
      win_len = forecast_parameters$win_len,
      win_type_expanding = forecast_parameters$win_type_expanding
      ) %>% 
      rename(!!sym(temp_name) := GaR_forecast)
    
    
    return(temp_df)

  }
  
  )

```


```{r r_squared}

forecast_model_fit$r2 = forecast_data_list %>% 
  reduce(inner_join,by = c("Quantile", "Horizon", "Date")) %>% 
  mutate(Forecast_Period = paste(
    Date + as.numeric(Horizon) * 0.25 - 1,
    Date + as.numeric(Horizon) * 0.25,
    sep = "-")) %>% 
  inner_join(forecast_benchmarks$actual_gdp_df,
             by = "Forecast_Period") %>% 
  select(-Forecast_Period) %>% 
  group_by(Quantile, Horizon) %>% 
  summarise(across(
    contains("Forecast") & !"Intercept_Forecast",
    ~quantile.r2.score(
      realized_values = GDP_actual,
      forecast_values = .,
      quantile = as.numeric(Quantile[1]),
      benchmark_values = Intercept_Forecast)))



```


```{r plot_r_2}

forecast_model_fit$r2 %>% 
  pivot_longer(cols = -c("Horizon","Quantile")) %>% 
  ggplot(aes(x = Quantile, y = value, fill = name)) + 
  geom_col(position = "dodge") + 
  scale_fill_viridis_d() + 
  facet_wrap(~Horizon, scales = "free") + 
  theme(legend.position = "bottom", legend.title = element_blank())

```



```{r plot_actual}

forecast_benchmarks$actual_gdp_df %>% 
  separate(col = Forecast_Period, into = c("start","end"),
           sep = "-") %>% 
  mutate(start = as.yearqtr(start)) %>% 
  ggplot(aes(x = start, y = GDP_actual)) + 
  scale_y_continuous(labels = scales::percent_format()) + 
  geom_line()

```


```{r check_gar_intercept}

temp_df = list(forecast_data_list$GaR_Forecast,
     forecast_benchmarks$Intercept_Forecast) %>% 
  reduce(inner_join) %>% 
  filter(Quantile == "0.05") %>% 
  filter(Horizon == "8") %>% 
  mutate(Forecast_Period = paste(
    Date + as.numeric(Horizon) * 0.25 - 1,
    Date + as.numeric(Horizon) * 0.25,
    sep = "-")) %>% 
  select(-Quantile, -Horizon) %>% 
  inner_join(forecast_benchmarks$actual_gdp_df,
             by = "Forecast_Period") %>% 
  select(-Forecast_Period)

write_csv(temp_df,
"C:\\Users\\Misha\\Desktop\\r2_test_data.csv")

```



```{r plot_residuals}

temp_df %>% 
  mutate(across(c("GaR_forecast","Intercept_Forecast"),
                ~ GDP_actual - .)) %>% 
  select(-GDP_actual) %>% 
  pivot_longer(cols = -Date) %>% 
  ggplot(aes(x = Date, y = value, color = name)) +
  geom_line() + 
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") + 
  labs(x = "", y = "", title = "Prediction errors") + 
  scale_y_continuous(labels = scales::percent_format()) + 
  theme(legend.position = "bottom", legend.title = element_blank())


```

