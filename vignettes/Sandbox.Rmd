

```{r load_library}

library(devtools)

load_all()

```


```{r set_forecast_parameters}

theme_set(theme_bw())

forecast_parameters = list(
  win_len = 40,
  win_type_expanding = TRUE,
  df = df %>% filter(Date < as.yearqtr("2020Q1"))
    )

forecast_benchmarks = list()

forecast_data_list = list()

forecast_model_fit = list()

```


```{r make_actual_gdp_df}

forecast_benchmarks$actual_gdp_df = forecast_parameters$df %>% 
  select(Date, GDP) %>% 
  filter(complete.cases(.)) %>% 
  rename(GDP_actual = GDP) %>% 
  mutate(Forecast_Period = paste(Date - 1, Date, sep = "-")) %>% 
  select(-Date) %>% 
  select(Forecast_Period, GDP_actual)

```


```{r GaR_Forecast}

models_list = list(GaR_Forecast = partitions_list$basic_no_global_inf,
                   Intercept_Forecast = NULL,
                   Macro_Forecast = partitions_list$macro,
                   Basic_Forecast = partitions_list$two_features)


forecast_data_list = map(
  models_list,
  get.gar.forecast,
  vars_df = forecast_parameters$df,
  target_var_name = "GDP",
  horizon_list = parameters_list$horizon_list,
  quantile_vec = parameters_list$quantile_vec,
  pca.align.list = list(
    Dom_FCI = list(
      var_name = "Spread_CPI_corp",
      positive_direction = FALSE),
    Dom_Macro = list(var_name = "GDP"),
    Global = list(var_name = "rate_euro"),
    FinCycle = list(var_name = "Credit")),
  win_len = forecast_parameters$win_len,
  win_type_expanding = forecast_parameters$win_type_expanding
  )


forecast_benchmarks$Intercept_Forecast = forecast_data_list$Intercept_Forecast %>% 
  rename(Intercept_Forecast = GaR_forecast)

forecast_data_list = forecast_data_list[
  !names(forecast_data_list) == "Intercept_Forecast"]

rm(models_list)

```


```{r r_squared}

r2_df =  map(names(forecast_data_list),
             function(temp_name){
               merged_df = forecast_data_list[[temp_name]] %>% 
                 filter(complete.cases(.)) %>% 
                 mutate(Forecast_Period = paste(
                   Date + as.numeric(Horizon) * 0.25 - 1,
                   Date + as.numeric(Horizon) * 0.25,
                   sep = "-")) %>% 
                 mutate(Horizon = as_factor(Horizon)) %>% 
                 inner_join(forecast_benchmarks$Intercept_Forecast,
                            by = c("Quantile", "Horizon", "Date")) %>% 
                 inner_join(forecast_benchmarks$actual_gdp_df,
                            by = "Forecast_Period") %>% 
                 select(-Forecast_Period) %>% 
                 group_by(Horizon, Quantile) %>% 
                 summarise(!!sym(temp_name) := quantile.r2.score(
                   realized_estimates = GDP_actual,
                   forecast_values = GaR_forecast,
                   quantile = as.numeric(Quantile[1]),
                   benchmark_values = Intercept_Forecast))
  
             }) %>% 
  reduce(inner_join)
 

```



```{r plot_r_2}

r2_df %>% 
  pivot_longer(cols = -c("Horizon","Quantile")) %>% 
  ggplot(aes(x = Quantile, y = value, fill = name)) + 
  geom_col(position = "dodge") + 
  scale_fill_viridis_d() + 
  facet_wrap(~Horizon, scales = "free") + 
  theme(legend.position = "bottom", legend.title = element_blank())

```

