---
title: "Replication"
output:
  rmarkdown::pdf_document:
    latex_engine: xelatex
    keep_tex: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r packg_setup}

devtools::load_all()

library(GaRPackg)
```


```{r load_libraries}

library(tidyverse)

library(pls)

```


```{r Set_parameters}

setwd("C:\\Users\\Misha\\Documents\\GaRPackg\\vignettes")

partitions = list(domestic_macro = list('real_gdp_yoy', 'industrial_prod_yoy',
                                        'pmi',"cyclical_composite_yoy"),
                  domestic_fci = list('term_spread', 'corporate_spread',
                                      'interbank_spread','sovereign_spread',
                                      'securities_ba_spread',
                                      'equity_returns_qoq', 'policy_rate',
                                      'cpi_inflation', 
                                      'implied_yield_cpi_bond_yoy',
                                      'inflation_expectations',
                                      'fx_returns_qoq', 'fx_ba_spread',
                                      'equity_implied_vol'),
                  leverage = list('private_credit_gdp', 'loan_deposits_ratio',
                                  'tier1_rwa', 'npl_ratio', 'share_fx_loans',
                                  'nfc_debt_equity',
                                  'derivatives_assets_capital',
                                  'liquid_assets_st_liabilities',
                                  'net_fx_positions_capital'),
                  external = list('reer_yoy', 'ca_gdp', 'trade_gdp',
                                  'dom_investment_gdp'),
                  world_macro = list('world_real_gdp_yoy',
                                     'world_indus_prod_yoy'),
                  world_fci = list('vix', 'nasdaq_vol', 'nasdaq_returns_qoq',
                                   'oil_future_qoq','us_reer_eme_yoy'))

```


```{r read_data}

df = read.csv(paste0("C:\\Users\\Misha\\Documents\\GaR Python\\Israel",
                     " GaR\\Data\\Final\\final_data_israel.csv"))

```


```{r pls_partition}

target_list = list(domestic_macro = list("real_gdp_yoy", "pmi"),
                   domestic_fci = list("term_spread", "corporate_spread"),
                   leverage = list("private_credit_gdp"),
                   world_macro = list("world_real_gdp_yoy"),
                   world_fci = list("vix", "nasdaq_returns_qoq"))




```


```{r pca_partition}

partitons_pca = lapply(partitions, function(temp_part){
  
  temp_df = df %>% 
    select(date,unlist(temp_part)) %>% 
    filter_at(.vars = vars(-date),.vars_predicate = all_vars(!is.na(.)))
  
  temp_pca = prcomp(x = temp_df %>% 
                      select(-date) %>% 
                      scale(), center = FALSE)
  
  return(data.frame(date = temp_df$date, PCA = temp_pca$x[,1]))
  
  
})

```


The purpose of this document is the replication of GaR model analysis. The intial code is written in Python, this is an attemp to follow it using R.

\section{Analysis}

The analysis stage is based on clean data. The code have 5 different modules:
\begin{itemize}
  \item
  Partitions - groups the explanatory variables to partitons
  \item
  Quantile regressions - performs the estimation of target quantiles
  \item
  Conditional density - fits "smooth" density function to estimated quantiles
  \item
  Scenario simulation
  \item
  Gaussian mixture
\end{itemize}

\subsection{Partitions}
The purpose of this section is to group the variables to partitons. The use of partitons helps to extract common trends and illiminate idiosyncratic noise. The idea is to group the variables into partitions of economic similarity.
The IMF suggest the following broad categories:
\begin{itemize}
  \item
  Financial conditions - aims at capturing the price of risks embedded
  in asset prices, the ease of obtaining financing, the cost of funding,
  and the degree of financial stress
  \item
  Macrofinancial vulnerabilities
  \item
  Other factors
\end{itemize}

In this application `r length(partitions)` categories have been chosen. The categories are: 


\begin{itemize}

```{r, results="asis"}

cat(paste("\\item", gsub("_"," ",names(partitions))), sep = "\n")


```

\end{itemize}

The most recent code is using PLS method for grouping the variables to partitions. I start with PCA method and compare whether the results are close enought.
