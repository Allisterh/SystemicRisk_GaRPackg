---
title: "GaR analysis"
bibliography: C:\\Users\\internet\\Documents\\Refrences\\GaR.bib
fontsize: 11pt
output:
  rmarkdown::pdf_document:
    latex_engine: xelatex
    number_sections: true
    includes:
            in_header: C:\\Users\\internet\\Documents\\GaRpckg\\GaR-preamble.tex

vignette: >
  %\VignetteIndexEntry{GaR analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF_8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, echo = FALSE, message = FALSE,warning = FALSE,
  comment = "#>"
)
```


```{r setup}

devtools::load_all()

# library(GaRPackg)

setwd(paste0(file.path(Sys.getenv("USERPROFILE")),
             "\\Documents\\GaRPckg\\vignettes"))
```


```{r load_libraries}

library(cowplot)

library(gghighlight)

library(tidyselect)

library(tidyverse)

library(quantreg)

library(corrplot)

library(stargazer)

library(xtable)

```


```{r Set_parameters}

setwd(paste0(file.path(Sys.getenv("USERPROFILE"),fsep="\\"),
      "\\Documents\\GaRPackg\\vignettes"))

results = list()

parameters_list = list()

parameters_list$quantile_vec = c(0.05,0.25,0.5,0.75,0.95)

parameters_list$horizon_list = list(1,8,12)

parameters_list$drop_series = c("Vacancies_Rate","Telbor_1Y","STARTUP_FP",
                "Sovereigh_spread",
                "Interbank_spread","LT_real_rate_change","Indus_prod_ind",
                "ILS_EURO",
                "breakeven_inflation_5_10_fwd")

parameters_list$vars_to_rates = c("Ind_Prod_us","Ind_Prod_euro",
                                  "Ind_Prod_Israel","GDP_F",
                                  "Credit_to_non_fin_sector","TA125_Close",
                                  "Avg_House_Price_index")


```


```{r Set_partitions}

source("Partition-Specs.R",echo = FALSE)

current_partition = partitions_list$OZMG

```


```{r Import_data}

fame_df = read.csv(paste0(file.path(Sys.getenv("USERPROFILE"),fsep="\\"),
                          "\\OneDrive - Bank Of Israel",
                          "\\Data\\BoI\\GaR_Data\\data_fame.csv"),
                 stringsAsFactors = FALSE) %>% 
  slice(-(1:10)) %>% 
  rename(Date = 1) %>% 
  mutate(Date = as.yearqtr(Date, format = "%m/%d/%Y"))

gar_df = read.csv(paste0(get.current.user.path(),"\\OneDrive - Bank Of Israel",
                 "\\Data\\BoI\\GaR_Data\\raw_GaR_data.csv"),
                 stringsAsFactors = FALSE) %>% 
  rename(Date = date) %>% 
  mutate(Date = as.yearqtr(str_remove(Date,"\\."), format = "%Y%q"))

fame_non_na_vars = colnames(fame_df)[sapply(fame_df,function(temp_col){
                        sum(!is.na(temp_col)) == length(temp_col)})]

missing_vars = unlist(current_partition)[!unlist(current_partition) %in% fame_non_na_vars]


df = left_join(fame_df %>% select(-any_of(fame_non_na_vars), Date),
               gar_df %>% select(Date, any_of(missing_vars)), by = "Date")

# Drop short series

df = df %>% 
  select(-any_of(parameters_list$drop_series))


```


```{r Process_data}

# Convert to numeric

df = df %>% 
  mutate_if(is.character,.funs = list(~as.numeric(str_remove_all(.,","))))


# Append Euro rate

df = df %>% 
  mutate_at(vars(rate_euro, rate_euro_append), .funs = list(~na_if(.,""))) %>% 
  mutate(rate_euro = coalesce(rate_euro, rate_euro_append)) %>% 
  select(-rate_euro_append)


# Transform variables to rates of change YoY

df = df %>% 
  mutate_at(vars(any_of(parameters_list$vars_to_rates)),
            .funs = list(~./lag(.,4)-1))



```


```{r rename_vars}


rename_list = list(old_names = c("GDP_F","Ind_Prod_Israel",
                                 "Ind_Prod_advanced","ILS_USD_spread_pct",
                                 "TA_35_impl_vol","ILS_USD_impl_vol",
                                 "Credit_to_non_fin_sector",
                                 "Avg_House_Price_index"),
                   new_names = c("GDP","Ind_Prod","IP_adv",
                                 "FX_spread","VIX_TA",
                                 "FX_imp_vol","Credit","HousePrice"))

existing <- match(rename_list$old_names,names(df))

names(df)[na.omit(existing)] <- rename_list$new_names[which(!is.na(existing))]


current_partition = lapply(current_partition, function(temp_part){
  
  lapply(temp_part, function(temp_name){
  
  ind = which(rename_list$old_names == temp_name)
  
  if(length(ind) == 0){
    
    return(temp_name)
    
  } else {
    
    
    return(rename_list$new_names[ind])
    
  }
  
  
  return(rename_list$new_names[])
  
  
})

  
  
  
})


```


```{r Analysis}

results = run.GaR.analysis(partitions_list = current_partition,
                   vars_df = df,
                   horizon_list = parameters_list$horizon_list,
                   quantile_vec = parameters_list$quantile_vec,
                   pca.align.list = list(Dom_FCI = list(var_name = "Spread_CPI_corp",
                                                        positive_direction = FALSE)))


```


\section{Literature review}

```{r child="GaR-LitReview.Rmd", eval=FALSE}

```


\section{PCA results}

```{r plot_pca, child="GaR-Partition-Evaluation.Rmd"}


```


\section{Quantile regression results}

```{r plot_quantile_reg, child="GaR-Quantile-Regression.Rmd"}

```


\section{Stylized facts}

```{r child="GaR-StylizedFacts.Rmd"}

```


\section{GaR timeseries}

```{r plot_gar, child="GaR-Timeseries.Rmd"}

```

\section{Robustness}

```{r compare_predictions, child="GaR-Prediction-Comparison.Rmd",eval=FALSE}

```



\section{Bibliography}

<div id="refs"></div>


\section {Appendix}

```{r child="GaR-Appendix.Rmd", eval=FALSE}

```


```{r child="GaR-Variables-Desc-Chart.Rmd", eval=FALSE}

```


