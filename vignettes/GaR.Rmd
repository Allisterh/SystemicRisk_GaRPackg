---
title: "GaR analysis"
output:
  rmarkdown::pdf_document:
    latex_engine: xelatex
    number_sections: true
    includes:
            in_header: C:\\Users\\Misha\\Documents\GaR\\GaR-preamble.tex

vignette: >
  %\VignetteIndexEntry{GaR analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF_8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, echo = FALSE, message = FALSE,warning = FALSE,
  comment = "#>"
)
```


```{r setup}

devtools::load_all()

library(GaRPackg)

setwd("C:\\Users\\Misha\\Documents\\GaRPackg\\vignettes")
```


```{r load_libraries}

library(tidyselect)

library(tidyverse)

library(cowplot)

library(mFilter)

library(quantreg)

library(rlang)

```


```{r Import_data}

osnat_list = import.osnat.data()

michael_list = import.michael.data()

raw_df = full_join(osnat_list$osnat_df, michael_list$michael_df,
               by = "Date") %>% 
  arrange(Date)

```


```{r Import_BoI_forecast_data}

df_forecast = read.csv(paste0("C:\\Users\\Misha\\Documents\\Data\\BOI\\DSGE",
                              "\\DSGE and staff forecasts.csv"),
                       stringsAsFactors = FALSE)

names(df_forecast)[1] = "Date"

df_forecast = df_forecast  %>% 
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>% 
  mutate(Date = as.yearqtr(Date)) %>% 
  filter_at(.vars = vars(-Date),.vars_predicate = any_vars(!is.na(.))) %>% 
  rename_at(.vars = vars(-Date),.funs = list(~gsub("bi.staff_fct_","",.))) %>% 
  rename_at(.vars = vars(-Date),.funs = list(~gsub("_08","",.))) %>%
  rename_at(.vars = vars(-Date),.funs = list(~gsub("\\.Q$","",.)))



```


```{r Set_partitions}

partitions = list(Dom_Real = list("Ind_Prod_Israel",
                                  "GDP_F","C_FP","G_NDEFIMP_FP","INV_FP",
                                  "INV_NI_FP","EXP_ND_FP","IMP_ND_FP",
                                  "STARTUP_FP"),
                  Dom_Prices = list("breakeven_inflation_1Y",
                                    "breakeven_inflation_2_3_fwd",
                                    "breakeven_inflation_5_10_fwd",
                                    "CPI_season_adj",
                                    "CPI_no_house_fruits_season_adj",
                                    "CPI_no_house_season_adj",
                                    "CPI","CPI_no_house","CPI_no_fruits"),
                  Rates = list("BOI_rate","Telbor_1Y","real_rate_1",
                               "real_rate_2_3_fwd","real_rate_5_10_fwd"),
                  External = list("CA","ILS_USD","ILS_EURO",
                                  "ILS_Yen","ILS_GBP"),
                  Global = list("VIX","Ind_Prod_advanced",
                                "Brent","Commodity_Non_Energy",
                                "gdp_us","gdp_euro","gdp_japan",
                                "gdp_uk","infl_us","infl_euro",
                                "infl_japan","infl_uk","rate_euro","rate_us",
                                "rate_uk","rate_japan","US_10","EU_10",
                                "UK_10","JPN_10", "US_5","EU_5","UK_5","JPN_5",
                                "IMP_OECD"),
                  Labor = list("Labor_pop","Wage","EMP","Unemp_rate",
                               "Labor_force","Vacancies_Rate"),
                  National_Security = list("Tourists"),
                  Spread = list("ILS_USD_spread_pct","Interbank_spread",
                                "Sovereigh_spread","Spread_CPI_corp",
                                "Term_spread"),
                  Volatility = list("ILS_USD_impl_vol","TA_35_impl_vol"),
                  Returns = list("TA125_Close","Avg_House_Price_index"),
                  Credit = list("Credit_to_non_fin_sector"))



```


```{r Modify_partitions}

partitions$Risk = partitions[c("Spread","National_Security",
                                      "Volatility")] %>% 
  setNames(NULL) %>% 
  unlist() %>% 
  as.list()

partitions = partitions[!names(partitions) %in% c("Spread",
                                                 "National_Security",
                                                 "Volatility")]

partitions$Fin_Cycle = partitions[c("Returns","Credit")] %>% 
  setNames(NULL) %>% 
  unlist() %>% 
  as.list()

partitions = partitions[!names(partitions) %in% c("Returns","Credit")]

```


```{r Process_data}

vars_to_rates = c("Ind_Prod_advanced","Ind_Prod_Israel",
                  "GDP_F","C_FP","G_NDEFIMP_FP","INV_FP",
                  "INV_NI_FP","EXP_ND_FP","IMP_ND_FP","STARTUP_FP",
                  "CPI_season_adj","CPI_no_house_fruits_season_adj",
                  "CPI_no_house_season_adj","CPI", "CPI_no_house",
                  "CPI_no_fruits","ILS_USD","ILS_EURO","ILS_Yen","ILS_GBP",
                  "gdp_us","gdp_euro","gdp_japan","gdp_uk",
                  "Brent","Commodity_Non_Energy","Labor_pop",
                  "Wage","EMP","Labor_force","Tourists","TA125_Close",
                  "Avg_House_Price_index","Credit_to_non_fin_sector",
                  "IMP_OECD")

df = raw_df %>% 
  select(-GDP_F, -GDP_no_tax,-GDP_season_adj) %>% 
  rename(GDP_F = GDP_no_startup)

df = df %>% 
  mutate_at(.vars = vars(unlist(partitions$Dom_Real),CA),
            .funs = list(~c(rep(NA,3),rollsum(.,4))))

# Normalize CA by GDP

df = raw_df %>% 
  mutate(CA = CA / GDP_F)


# Transform variables to rates of change YoY

df = df %>% 
  mutate_at(vars(vars_to_rates),
            .funs = list(~./lag(.,4)-1))


# Calculate difference

df = df %>%
  mutate(real_rate_2_3_fwd = real_rate_2_3_fwd - real_rate_5_10_fwd) %>%
  mutate(BOI_rate = BOI_rate - real_rate_5_10_fwd) %>%
  mutate(US_5 = US_5 - US_10) %>%
  mutate(EU_5 = EU_5 - EU_10) %>%
  mutate(JPN_5 = JPN_5 - JPN_10) %>%
  mutate(Ger_5 = Ger_5 - Ger_10) %>%
  mutate(UK_5 = UK_5 - UK_10) %>%
  mutate(rate_us = rate_us - US_10) %>%
  mutate(rate_euro = rate_euro - EU_10) %>%
  mutate(rate_japan = rate_japan - JPN_10) %>%
  mutate(rate_uk = rate_uk - UK_10) %>%
  select(-ends_with("10"))

```


```{r drop_short_series}

drop_series = c("Vacancies_Rate","Telbor_1Y","STARTUP_FP",
                "Term_spread","Sovereigh_spread",
                "Interbank_spread","LT_real_rate_change",
                "TA125_Close","Indus_prod_ind","ILS_EURO",
                "breakeven_inflation_5_10_fwd")

df = df %>% 
  select(-drop_series)

```


```{r calculate_pca}


pca_list = lapply(partitions[sapply(partitions, length) > 1],
                  function(temp_part){
  
  part_df = df %>% 
    select(unlist(temp_part)[unlist(temp_part) %in% names(df)], Date) %>% 
    filter_all(all_vars(is.finite(.)))
  
  ret_list = list(pca = part_df %>%
                    select(-Date) %>% 
                    prcomp(.,center = TRUE,scale. = TRUE),
                  date_index = part_df$Date)
  
  return(ret_list)
  
})


partitions_df = lapply(names(pca_list), function(temp_name){
  
  temp_df = data.frame(Date = pca_list[[temp_name]]$date_index,
                       PCA = pca_list[[temp_name]]$pca$x[,1],
                       stringsAsFactors = FALSE)
  
  names(temp_df) = c("Date",temp_name)
  
  return(temp_df)
  
  
  
  
}) %>% 
  reduce(full_join, by = "Date") %>% 
  arrange(Date)

# Normalize sign pca

pca_list$Dom_Real$pca$rotation = pca_list$Dom_Real$pca$rotation *
  sign(pca_list$Dom_Real$pca$rotation["GDP_F",1])

pca_list$Dom_Prices$pca$rotation = pca_list$Dom_Prices$pca$rotation *
  sign(pca_list$Dom_Prices$pca$rotation["CPI",1])

pca_list$Rates$pca$rotation = pca_list$Rates$pca$rotation *
  sign(pca_list$Rates$pca$rotation["BOI_rate",1])

pca_list$Global$pca$rotation = pca_list$Global$pca$rotation *
  sign(pca_list$Global$pca$rotation["gdp_us",1])

pca_list$Labor$pca$rotation = pca_list$Labor$pca$rotation *
  sign(pca_list$Labor$pca$rotation["Unemp_rate",1]) * (-1)



```


```{r quantile_reg}

reg_df = lapply(names(pca_list), function(temp_name){
  
  df = data.frame(Date = as.yearqtr(pca_list[[temp_name]][["date_index"]]),
             Temp_Var = pca_list[[temp_name]][["pca"]][["x"]][,1]) %>% 
    rename(!!quo_name(temp_name) := Temp_Var)
  
  return(df)
  

}) %>% 
  reduce(inner_join, by = "Date") %>% 
  left_join(df %>%
              select(GDP_F, Date) %>%
              mutate(GDP_F_1 = lead(GDP_F,1)) %>% 
              mutate(GDP_F_4 = lead(GDP_F,4)),
            by = "Date")

# Add back variables in case there are partitions with one variable

if(length(partitions) > length(pca_list)){

one_dim_vars = partitions[sapply(partitions, length) == 1] %>% 
  unlist() %>% 
  setNames(NULL)


reg_df = reg_df %>% 
  left_join(df %>% 
  select(Date, one_dim_vars) %>% 
  mutate_at(vars(-Date), .funs = list(~as.numeric(scale(.)))),
  by = "Date")

}
tau_vec = c(0.1,0.25,0.5,0.75,0.9)

quant_reg_list = rq(formula = formula(GDP_F_1~.),tau = tau_vec,
              data = reg_df %>% select(-Date, -GDP_F, -GDP_F_4))


sum_quant_reg = summary(quant_reg_list)

names(sum_quant_reg) = paste("tau",tau_vec, sep = "=")

```


\section{Quantile regression results}

```{r plot_quantile_reg}

```




\subsection{Comparing prediction accuracy}

In this section we'll compare the quantile regression predictions to BoI staff forecast. There are two types of comparison: 

\begin{itemize}
  \item
  Fixed prediction - the prediction is based on a coefficients estimated using
  the entire sample (that is simply the fitted values of the qunatile regression).
  \item
  Rolling prediction - the prediction is based on a coefficients estimated using
  the subset sample that is increased at each step.

\end{itemize}


```{r prediction, eval=FALSE}

df_fixed_pred = cbind(reg_df$Date,
                      as.data.frame(quant_reg_list$fitted.values)) %>% 
  setNames(c("Date", paste("tau",tau_vec, "Q_1", sep = "_"))) %>% 
  mutate_at(.vars = vars(-Date),.funs = list(~ . * 100)) %>% 
  left_join(df_forecast %>% 
              select(Date,ends_with("Q_1")),
            by = "Date") %>% 
  filter_at(vars(-"Date", -starts_with("tau")), any_vars(!is.na(.)))

```


```{r plot_prediction, eval=FALSE}

ggplot(df_fixed_pred, aes(x = Date, y = tau_0.5_Q_1 - shiputit_Q_1)) + 
  geom_line() + 
  scale_x_yearqtr(n = 10, format = "%YQ%q") + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "blue") + 
  labs(x = "", y = "Percent", title = paste0("Difference between prediction",
                                             " (tau = 0.5) \n and staff forecast",
                                             " (shiputit)")) + 
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5))

```


\section{PCA results}

```{r plot_pca, child="GaR-Partition-Evaluation.Rmd"}


```


\section {Appendix}

\subsection{Data transformation}

<!-- The data is reported with quarterly frequency, the following transformation are performed : -->

Dom_Real partition and CA (quarterly frequency) are transformed with rolling (4 quarter window) sum.



\subsection{Data structure}

The following series were dropped because of short length

```{r results='asis'} 

cat(paste('-', drop_series), sep = '\n') 

``` 


```{r plot_data_structure, fig.height=8}

ggplot(raw_df %>%
  mutate_at(.vars = vars(-Date),
            .funs = list(~is.na(.))) %>%
  gather(key = Indicator, value = Missing, -Date) %>% 
    mutate(Missing = as.factor(Missing)) %>% 
    group_by(Indicator) %>% 
    mutate(Miss_count = sum(Missing == TRUE)) %>% 
    ungroup(),
  aes(x = Date, y = reorder(Indicator, Miss_count),color = Missing)) + 
  geom_point(size = 0.6) + 
  scale_color_manual(values = c("FALSE" = "lightgray",
                                "TRUE" = "magenta")) +
  scale_x_yearqtr(format = "%YQ%q",n = 25) + 
  labs(x = "",y = "", title = "Missing data structure") + 
  theme_bw() + 
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, vjust = 0.5),
        axis.text.y = element_text(size = 4),
        plot.title = element_text(hjust = 0.5))

```


```{r child="GaR-Variables-Desc-Chart.Rmd"}

```

