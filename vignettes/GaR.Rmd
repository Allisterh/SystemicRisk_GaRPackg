---
title: "GaR analysis"
bibliography: C:\\Users\\internet\\Documents\\Refrences\\GaR.bib
fontsize: 11pt
output:
  rmarkdown::pdf_document:
    latex_engine: xelatex
    number_sections: true
    includes:
            in_header: C:\\Users\\internet\\Documents\\GaRpckg\\vignettes\\Preamble.tex

vignette: >
  %\VignetteIndexEntry{GaR analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF_8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, echo = FALSE, message = FALSE,warning = FALSE,
  comment = "#>"
)
```


```{r setup}

devtools::load_all()

library(GaRPackg)

# setwd("C:\\Users\\Misha\\Documents\\GaRPackg\\vignettes")
```


```{r load_libraries}

library(cowplot)

library(gghighlight)

library(tidyselect)

library(tidyverse)

library(quantreg)

library(rlang)

```


```{r Import_data}

raw_data = list(osnat_list = import.osnat.data(),
                michael_list = import.michael.data())

raw_data$raw_df = full_join(raw_data$osnat_list$osnat_df,
                            raw_data$michael_list$michael_df,
                            by = "Date") %>% 
  arrange(Date)

```


```{r Set_parameters}

setwd("C:\\Users\\internet\\Documents\\GaRpckg\\vignettes")


results = list()

parameters_list = list()

parameters_list$quantile_vec = c(0.05,0.25,0.5,0.75,0.95)

parameters_list$horizon_list = list(1,8,12)

parameters_list$drop_series = c("Vacancies_Rate","Telbor_1Y","STARTUP_FP",
                "Term_spread","Sovereigh_spread",
                "Interbank_spread","LT_real_rate_change",
                "TA125_Close","Indus_prod_ind","ILS_EURO",
                "breakeven_inflation_5_10_fwd")


```


```{r Set_partitions_list}

partitions = list(Dom_Real = list("GDP_F","Ind_Prod_Israel",
                                  "C_FP","G_NDEFIMP_FP","INV_FP",
                                  "INV_NI_FP","EXP_ND_FP","IMP_ND_FP",
                                  "STARTUP_FP"),
                  Dom_Prices = list("CPI","breakeven_inflation_1Y",
                                    "breakeven_inflation_2_3_fwd",
                                    "breakeven_inflation_5_10_fwd",
                                    "CPI_season_adj",
                                    "CPI_no_house_fruits_season_adj",
                                    "CPI_no_house_season_adj",
                                    "CPI_no_house","CPI_no_fruits"),
                  Rates = list("BOI_rate","Telbor_1Y","real_rate_1",
                               "real_rate_2_3_fwd","real_rate_5_10_fwd"),
                  External = list("CA","ILS_USD","ILS_EURO",
                                  "ILS_Yen","ILS_GBP"),
                  Global = list("VIX","Ind_Prod_advanced",
                                "Brent","Commodity_Non_Energy",
                                "gdp_us","gdp_euro","gdp_japan",
                                "gdp_uk","infl_us","infl_euro",
                                "infl_japan","infl_uk","rate_euro","rate_us",
                                "rate_uk","rate_japan","US_10","EU_10",
                                "UK_10","JPN_10", "US_5","EU_5","UK_5","JPN_5",
                                "IMP_OECD"),
                  Labor = list("Wage","EMP","Unemp_rate","Vacancies_Rate"),
                  National_Security = list("Tourists"),
                  Spread = list("Spread_CPI_corp",
                                "ILS_USD_spread_pct","Interbank_spread",
                                "Sovereigh_spread",
                                "Term_spread"),
                  Volatility = list("ILS_USD_impl_vol","TA_35_impl_vol"),
                  Returns = list("TA125_Close"),
                  Credit = list("Credit_to_non_fin_sector",
                                "Avg_House_Price_index"))



```


```{r Robustness_partitions}

baseline_partitions = partitions

baseline_partitions$Risk = baseline_partitions[c("Spread","National_Security",
                                      "Volatility")] %>% 
  setNames(NULL) %>% 
  unlist() %>% 
  as.list()

baseline_partitions = baseline_partitions[!names(baseline_partitions) %in%
                                            c("Spread",
                                              "National_Security",
                                              "Volatility")]

baseline_partitions$Fin_Cycle = baseline_partitions[c("Credit","Returns")] %>% 
  setNames(NULL) %>% 
  unlist() %>% 
  as.list()

baseline_partitions = baseline_partitions[!names(baseline_partitions) %in%
                                            c("Credit","Returns")]

##############################################################################


no_labor_partitions = baseline_partitions

no_labor_partitions$Dom_Real = baseline_partitions[c("Dom_Real","Labor")] %>% 
  setNames(NULL) %>% 
  unlist() %>% 
  as.list()

no_labor_partitions = baseline_partitions[!names(baseline_partitions) %in%
                                            c("Dom_Real","Labor")]

no_risk_partition = baseline_partitions

no_risk_partition$Rates = baseline_partitions[c("Rates","Risk")] %>% 
  setNames(NULL) %>% 
  unlist() %>% 
  as.list()

no_risk_partition = baseline_partitions[!names(baseline_partitions) %in%
                                            c("Rates","Risk")]


partitions_robustness_test = list(baseline = baseline_partitions,
                                  no_labor = no_labor_partitions,
                                  no_risk = no_risk_partition)

rm(baseline_partitions, no_labor_partitions, no_risk_partition)

```


```{r Process_data}

vars_to_rates = c("Ind_Prod_advanced","Ind_Prod_Israel",
                  "GDP_F","C_FP","G_NDEFIMP_FP","INV_FP",
                  "INV_NI_FP","EXP_ND_FP","IMP_ND_FP","STARTUP_FP",
                  "CPI_season_adj","CPI_no_house_fruits_season_adj",
                  "CPI_no_house_season_adj","CPI", "CPI_no_house",
                  "CPI_no_fruits","ILS_USD","ILS_EURO","ILS_Yen","ILS_GBP",
                  "gdp_us","gdp_euro","gdp_japan","gdp_uk",
                  "Brent","Commodity_Non_Energy","Labor_pop",
                  "Wage","EMP","Labor_force","Tourists","TA125_Close",
                  "Avg_House_Price_index","Credit_to_non_fin_sector",
                  "IMP_OECD")

df = raw_data$raw_df %>% 
  select(-GDP_F, -GDP_no_tax,-GDP_season_adj) %>% 
  rename(GDP_F = GDP_no_startup)

# df = df %>% 
#   mutate_at(.vars = vars(unlist(baseline_partitions$Dom_Real),CA),
#             .funs = list(~c(rep(NA,3),rollsum(.,4))))

# Normalize CA by GDP

df = df %>% 
  mutate(CA = CA / GDP_F)


# Transform variables to rates of change YoY

df = df %>% 
  mutate_at(vars(vars_to_rates),
            .funs = list(~./lag(.,4)-1))


# Calculate difference

df = df %>%
  mutate(real_rate_2_3_fwd = real_rate_2_3_fwd - real_rate_5_10_fwd) %>%
  mutate(BOI_rate = BOI_rate - real_rate_5_10_fwd) %>%
  mutate(US_5 = US_5 - US_10) %>%
  mutate(EU_5 = EU_5 - EU_10) %>%
  mutate(JPN_5 = JPN_5 - JPN_10) %>%
  mutate(Ger_5 = Ger_5 - Ger_10) %>%
  mutate(UK_5 = UK_5 - UK_10) %>%
  mutate(rate_us = rate_us - US_10) %>%
  mutate(rate_euro = rate_euro - EU_10) %>%
  mutate(rate_japan = rate_japan - JPN_10) %>%
  mutate(rate_uk = rate_uk - UK_10) %>%
  select(-ends_with("10"))

```


```{r make_data_list}

data_list = list()

data_list$complete_cases_df = df %>%
  filter(complete.cases(.))

data_list$long_series_df = df %>% 
  select(-!!(parameters_list$drop_series))


data_list$interpolated_df = df %>%
  mutate_at(.vars = vars(-Date), interpolate)



```


```{r Analysis}

results = lapply(partitions_robustness_test, function(temp_partition){
  run.GaR.analysis(partitions_list = temp_partition,
                   vars_df = data_list$long_series_df,
                   horizon_list = parameters_list$horizon_list,
                   quantile_vec = parameters_list$quantile_vec)

})

names(results) = names(partitions_robustness_test)

```


\section{Literature review}

```{r child="GaR-LitReview.Rmd"}

```


\section{PCA results}

```{r plot_pca, child="GaR-Partition-Evaluation.Rmd"}


```


\section{Quantile regression results}

```{r plot_quantile_reg, child="GaR-Quantile-Regression.Rmd"}

```


\section{GaR timeseries}

```{r plot_gar, child="GaR-Timeseries.Rmd"}

```


\section{Prediction}

```{r , child="GaR-Prediction-Comparison.Rmd"}

```


\section{Bibliography}

<div id="refs"></div>


\section {Appendix}

```{r child="GaR-Appendix.Rmd", eval=FALSE}

```

